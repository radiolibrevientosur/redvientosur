import{z as M,r as n,R as V,e as z,s as l,j as e,L as B,H,M as F}from"./index-CkCNI7dU.js";import G from"./NotFoundPage-ChDOTPqR.js";import{$ as J,d as K}from"./native-DGJ9haqb.js";import{S as O}from"./share-2-D6YOoNpV.js";const Y=()=>{const{id:h}=M(),[t,k]=n.useState(null),[q,f]=n.useState(!0),[u,_]=n.useState([]),[L,w]=n.useState({}),[x,b]=n.useState([]),[g,S]=n.useState(!1),[d,p]=n.useState(""),[D,y]=n.useState(!1),[C,E]=n.useState(!0),j=V.useRef(null),{user:i}=z(),v=i?x.includes(i.id):!1;n.useEffect(()=>{h&&(async()=>{f(!0);const{data:a,error:s}=await l.from("publicaciones").select("id, titulo, excerpt, imagen_portada, categoria, publicado_en, autor_id").eq("id",h).eq("tipo","blog").single();if(!a||s){k(null),f(!1);return}let r={nombre_completo:"Autor",avatar_url:"/default-avatar.png",id:"",nombre_usuario:""};if(a.autor_id){const{data:m}=await l.from("usuarios").select("id, nombre_completo, avatar_url, nombre_usuario").eq("id",a.autor_id).single();m&&(r=m)}const{count:o}=await l.from("comentarios_blog").select("*",{count:"exact",head:!0}).eq("publicacion_id",a.id),{count:c}=await l.from("reacciones_blog").select("*",{count:"exact",head:!0}).eq("publicacion_id",a.id).eq("tipo","like");k({id:a.id,title:a.titulo,excerpt:a.excerpt,coverImage:a.imagen_portada,authorId:r.id,authorUsername:r.nombre_usuario,authorName:r.nombre_completo,authorAvatar:r.avatar_url,published:a.publicado_en,category:a.categoria||"General",commentsCount:o||0,likesCount:c||0}),f(!1)})()},[h]),n.useEffect(()=>{if(!t)return;const a=async()=>{E(!0);const{data:r}=await l.from("comentarios_blog").select("*, autor:usuarios(id, nombre_completo, avatar_url)").eq("publicacion_id",t.id).order("creado_en",{ascending:!0});if(_(r||[]),r&&r.length>0){const o={};r.forEach(c=>{c.autor&&(o[c.autor.id]=c.autor)}),w(o)}E(!1)},s=async()=>{const{data:r}=await l.from("reacciones_blog").select("usuario_id").eq("publicacion_id",t.id).eq("tipo","like");b(r?r.map(o=>o.usuario_id):[])};a(),s()},[t]);const I=async()=>{!i||!t||(v?(await l.from("reacciones_blog").delete().eq("publicacion_id",t.id).eq("usuario_id",i.id).eq("tipo","like"),b(x.filter(a=>a!==i.id))):(await l.from("reacciones_blog").insert({publicacion_id:t.id,usuario_id:i.id,tipo:"like"}),b([...x,i.id])))},P=()=>{if(!t)return;const a=window.location.origin+"/blogs/"+t.id;navigator.share?navigator.share({title:t.title,text:t.excerpt,url:a}).catch(()=>{}):(navigator.clipboard.writeText(a),typeof toast<"u"&&toast.success("¡Enlace copiado!"))},R=async a=>{if(a.preventDefault(),i&&d.trim()&&t){const{error:s,data:r}=await l.from("comentarios_blog").insert({publicacion_id:t.id,autor_id:i.id,contenido:d.trim()}).select("*, autor:usuarios(id, nombre_completo, avatar_url)").single();!s&&r&&(p(""),y(!1),_(o=>[...o,r]),w(o=>({...o,[i.id]:r.autor})))}},$=a=>{var s,r,o,c;if(j.current){const m=j.current,N=m.selectionStart||0,A=m.selectionEnd||0,T=d.slice(0,N)+(a.native||((r=(s=a.skins)==null?void 0:s[0])==null?void 0:r.native)||"")+d.slice(A);p(T),setTimeout(()=>{m.focus(),m.setSelectionRange(N+2,N+2)},0)}else p(d+(a.native||((c=(o=a.skins)==null?void 0:o[0])==null?void 0:c.native)||""));y(!1)};return q?e.jsx("div",{className:"py-8 flex justify-center",children:e.jsx(B,{message:"Cargando artículo..."})}):t?e.jsxs("div",{className:"max-w-2xl mx-auto p-4",children:[e.jsx("button",{onClick:()=>window.location.href="/",className:"text-primary-600 dark:text-primary-400 hover:underline mb-4",children:"← Volver a inicio"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("img",{src:t.coverImage,alt:t.title,className:"w-full h-64 object-cover rounded-lg mb-4"}),e.jsxs("div",{className:"flex items-center text-xs text-gray-500 dark:text-gray-400 mb-2",children:[e.jsx("span",{className:"bg-primary-100 dark:bg-primary-900/30 text-primary-600 dark:text-primary-400 px-2 py-0.5 rounded-full",children:t.category}),e.jsx("span",{className:"mx-2",children:"•"}),e.jsx("span",{children:new Date(t.published).toLocaleDateString("es-ES")})]}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-2",children:t.title}),e.jsx("p",{className:"text-gray-700 dark:text-gray-300 mb-4",children:t.excerpt}),e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("img",{src:t.authorAvatar,alt:t.authorName,className:"w-8 h-8 rounded-full border border-gray-300 dark:border-gray-700"}),e.jsx("span",{className:"font-medium text-gray-900 dark:text-white text-sm",children:t.authorName})]}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-gray-500 mb-4",children:[e.jsxs("button",{onClick:I,className:"flex items-center space-x-1 group",children:[e.jsx(H,{className:`h-5 w-5 ${v?"text-red-500 fill-red-500":"text-gray-600 dark:text-gray-400 group-hover:text-red-500"}`}),e.jsx("span",{className:`text-sm ${v?"text-red-500":"text-gray-600 dark:text-gray-400 group-hover:text-red-500"}`,children:x.length})]}),e.jsxs("button",{onClick:()=>S(!g),className:"flex items-center space-x-1 group",children:[e.jsx(F,{className:"h-5 w-5 text-gray-600 dark:text-gray-400 group-hover:text-primary-500"}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400 group-hover:text-primary-500",children:u.length})]}),e.jsx("button",{onClick:P,className:"flex items-center group",title:"Compartir",children:e.jsx(O,{className:"h-5 w-5 text-gray-600 dark:text-gray-400 group-hover:text-primary-500"})})]}),(u.length>0||g)&&e.jsxs("div",{className:"px-0 py-3 bg-gray-50 dark:bg-gray-800/50 rounded-b-xl",children:[u.length>0&&e.jsxs("div",{className:"mb-3 space-y-3",children:[u.slice(0,g?void 0:2).map(a=>{const s=L[a.autor_id]||a.autor;return e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("div",{className:"avatar w-8 h-8",children:C?e.jsx("div",{className:"w-8 h-8 bg-gray-200 rounded-full animate-pulse"}):e.jsx("img",{src:(s==null?void 0:s.avatar_url)||"/default-avatar.png",alt:(s==null?void 0:s.nombre_completo)||"Usuario",className:"avatar-img"})})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-900 p-2 rounded-lg",children:[e.jsx("p",{className:"font-medium text-sm text-gray-900 dark:text-white",children:C?e.jsx("span",{className:"bg-gray-200 rounded w-16 h-3 inline-block animate-pulse"}):(s==null?void 0:s.nombre_completo)||"Usuario"}),e.jsx("p",{className:"text-sm text-gray-700 dark:text-gray-300",children:a.contenido})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:new Date(a.creado_en).toLocaleDateString("es-ES")})]})]},a.id)}),u.length>2&&!g&&e.jsxs("button",{onClick:()=>S(!0),className:"text-sm text-primary-600 dark:text-primary-400 font-medium",children:["Ver los ",u.length," comentarios"]})]}),i&&e.jsxs("form",{onSubmit:R,className:"flex items-center space-x-2 relative",children:[e.jsx("div",{className:"avatar w-8 h-8",children:e.jsx("img",{src:i.avatar,alt:i.displayName,className:"avatar-img"})}),e.jsx("input",{ref:j,type:"text",placeholder:"Añade un comentario...",className:"flex-1 bg-white dark:bg-gray-900 rounded-full px-4 py-2 text-sm border border-gray-200 dark:border-gray-700 focus:ring-1 focus:ring-primary-500 focus:border-primary-500",value:d,onChange:a=>p(a.target.value)}),e.jsx("button",{type:"button",className:"p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800",onClick:()=>y(a=>!a),"aria-label":"Insertar emoji",tabIndex:-1,children:e.jsx("span",{role:"img","aria-label":"emoji",children:"😊"})}),e.jsx("button",{type:"submit",disabled:!d.trim(),className:"text-sm font-medium text-primary-600 dark:text-primary-400 disabled:opacity-50",children:"Publicar"}),D&&e.jsx("div",{className:"absolute z-50 bottom-12 right-0",children:e.jsx(J,{data:K,onEmojiSelect:$,theme:"auto"})})]})]})]})]}):e.jsx(G,{})};export{Y as default};
