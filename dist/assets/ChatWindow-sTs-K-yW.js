import{r as s,s as p,u as ue,j as t,Z as me,I as xe,d as I}from"./index-BGdIQiaM.js";import{$ as pe,d as he}from"./native-Cp8PlxG7.js";import{a as fe,F as be,M as ge,A as ve}from"./AudioRecorder-DfWx_NTv.js";function we(o){const[k,S]=s.useState([]),[i,m]=s.useState([]),[M,x]=s.useState(!1),C=s.useCallback(async()=>{x(!0);const{data:c,error:r}=await p.rpc("get_conversations",{user_id:o});!r&&c&&S(c),x(!1)},[o]),h=s.useCallback(async c=>{x(!0);const{data:r,error:d}=await p.from("messages").select("*").or(`and(sender_id.eq.${o},receiver_id.eq.${c}),and(sender_id.eq.${c},receiver_id.eq.${o})`).order("created_at",{ascending:!0});!d&&r&&m(r),x(!1)},[o]),g=s.useCallback(async(c,r)=>{const{data:d,error:f}=await p.from("messages").insert({sender_id:o,receiver_id:c,content:r}).select().single();return!f&&d&&m(j=>[...j,d]),{data:d,error:f}},[o]);return s.useEffect(()=>{const c=p.channel("messages").on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},r=>{const d=r.new;(d.sender_id===o||d.receiver_id===o)&&m(f=>[...f,d])}).subscribe();return()=>{p.removeChannel(c)}},[o]),{conversations:k,messages:i,loading:M,fetchConversations:C,fetchMessages:h,sendMessage:g}}const Re=({otherUserId:o,otherUserName:k,otherUserAvatar:S})=>{var J;const{user:i}=ue(),{messages:m,fetchMessages:M,sendMessage:x,loading:C}=we((i==null?void 0:i.id)||""),[h,g]=s.useState(""),[c,r]=s.useState(!1),[d,f]=s.useState(!1),[j,O]=s.useState(null),[U,q]=s.useState(!1),[$,Y]=s.useState(!1),[ee,y]=s.useState(null),[H,te]=s.useState({}),[N,_]=s.useState(null),G=s.useRef(null),E=s.useRef(null),D=s.useRef(null),A=s.useRef(null),R=s.useRef(null),[T,z]=s.useState(!1),v=s.useRef(null),[P,w]=s.useState("none"),ae=60,se=60;s.useEffect(()=>{i!=null&&i.id&&o&&M(o)},[i,o,M]),s.useEffect(()=>{var e;(e=G.current)==null||e.scrollIntoView({behavior:"smooth"})},[m]);const ne=async e=>{if(e.preventDefault(),!(!h.trim()&&!j||C)){if(j)await x(o,j),O(null);else{const a=h.trim();i==null||i.id,new Date().toISOString(),N&&(N.id,N.content),await x(o,a),setTimeout(()=>{_(null)},100)}g("")}},oe=e=>{g(h+(e.native||"")),r(!1)},ie=async e=>{e&&(await x(o,e),O(null),g("")),f(!1)},X=e=>{var a,n,l;e==="media"&&((a=E.current)==null||a.click()),e==="music"&&((n=D.current)==null||n.click()),e==="doc"&&((l=A.current)==null||l.click())},F=async(e,a)=>{var l;const n=(l=e.target.files)==null?void 0:l[0];if(q(!1),!!n){Y(!0);try{const b=n.name.split(".").pop(),K=`${a==="media"?"chat-media":a==="music"?"chat-music":"chat-docs"}/${Date.now()}_${Math.random().toString(36).substring(2,8)}.${b}`,{error:Q}=await p.storage.from("media").upload(K,n);if(Q)throw Q;const{data:de}=p.storage.from("media").getPublicUrl(K);await x(o,de.publicUrl),I.success("Archivo enviado")}catch{I.error("Error al subir archivo")}finally{Y(!1),E.current&&(E.current.value=""),D.current&&(D.current.value=""),A.current&&(A.current.value="")}}},V=e=>{f(!0),z(!0),w("none");let a=0,n=0;"touches"in e&&e.touches.length>0?(a=e.touches[0].clientX,n=e.touches[0].clientY):"clientX"in e&&(a=e.clientX,n=e.clientY),v.current={x:a,y:n},setTimeout(()=>{var l;(l=R.current)==null||l.startRecording()},50)},W=e=>{if(!T||!v.current)return;let a=0,n=0;"touches"in e&&e.touches.length>0?(a=e.touches[0].clientX,n=e.touches[0].clientY):"clientX"in e&&(a=e.clientX,n=e.clientY);const l=a-v.current.x,b=n-v.current.y;l<-ae?w("left"):b<-se?w("up"):w("none")},le=()=>T?P==="left"?t.jsx("span",{className:"absolute left-0 bottom-14 text-xs bg-red-600 text-white px-2 py-1 rounded shadow animate-shake",children:"Desliza a la izquierda para cancelar"}):P==="up"?t.jsx("span",{className:"absolute right-0 bottom-14 text-xs bg-blue-600 text-white px-2 py-1 rounded shadow animate-bounce",children:"Desliza hacia arriba para previsualizar"}):t.jsx("span",{className:"absolute bottom-14 left-1/2 -translate-x-1/2 text-xs bg-gray-700 text-white px-2 py-1 rounded shadow",children:"Suelta para enviar"}):null,Z=()=>{var e,a;z(!1),P==="left"?(e=R.current)==null||e.cancelRecording():(a=R.current)==null||a.stopRecording(),w("none"),v.current=null},B=()=>{var e;z(!1),(e=R.current)==null||e.cancelRecording(),w("none"),v.current=null},L=(e,a)=>{te(n=>({...n,[e]:a})),y(null)},ce=e=>{_(e),y(null)},re=async e=>{if(e.sender_id===(i==null?void 0:i.id)){if(await p.from("messages").delete().eq("id",e.id),Array.isArray(m)){const a=m.findIndex(n=>n.id===e.id);a!==-1&&m.splice(a,1)}y(null)}};return t.jsxs("div",{className:"flex flex-col h-full border rounded shadow bg-white max-w-full sm:max-w-md mx-auto w-full min-h-[80vh] sm:min-h-[500px] relative md:rounded-xl md:shadow-lg md:border md:bg-white",children:[t.jsxs("div",{className:"p-2 border-b font-semibold flex items-center gap-2 bg-white sticky top-0 z-10 min-h-[48px] sm:min-h-[56px] md:rounded-t-xl",children:[S&&t.jsx("img",{src:S,alt:k||o,className:"w-9 h-9 rounded-full object-cover"}),t.jsxs("span",{className:"truncate text-base sm:text-lg",children:["Chat con ",k||o]})]}),t.jsxs("div",{className:"flex-1 overflow-y-auto p-2 sm:p-4 space-y-2 bg-gray-50 hide-scrollbar min-h-[60vh] max-h-[70vh] md:rounded-b-xl",children:[C?t.jsx("div",{children:"Cargando mensajes..."}):m.map(e=>{var b;const a=e.content&&e.content.startsWith("http");let n=null;if(a){const u=e.content;u.match(/\.(jpg|jpeg|png|gif|webp)$/i)?n=t.jsx("img",{src:u,alt:"imagen adjunta",className:"max-w-[180px] max-h-40 rounded mb-1"}):u.match(/\.(mp4|webm|mov)$/i)?n=t.jsx("video",{src:u,controls:!0,className:"max-w-[180px] max-h-40 rounded mb-1"}):u.match(/\.(mp3|wav|ogg)$/i)?n=t.jsx("audio",{src:u,controls:!0,className:"w-full my-1"}):n=t.jsx("a",{href:u,target:"_blank",rel:"noopener noreferrer",className:"block text-blue-200 underline break-all mb-1",children:"Documento adjunto"})}const l=e.sender_id===(i==null?void 0:i.id);return t.jsxs("div",{className:"relative group",children:[t.jsxs("div",{className:`max-w-xs px-3 py-2 rounded-lg text-sm shadow-md ${l?"bg-blue-600 text-white ml-auto":"bg-gray-700 text-white mr-auto"}`,onContextMenu:u=>{u.preventDefault(),y(e.id)},onClick:()=>y(e.id),tabIndex:0,"aria-label":"Acciones de mensaje",children:[e.reply_to&&t.jsxs("div",{className:"text-xs text-blue-200 mb-1 border-l-2 border-blue-300 pl-2 italic",children:["Respondiendo a: ",(b=e.reply_to.content)==null?void 0:b.slice(0,40),"..."]}),a?n:e.content,H[e.id]&&t.jsx("div",{className:"mt-1 flex items-center gap-1",children:t.jsx("span",{className:"bg-white/80 text-black rounded-full px-2 py-0.5 text-base border border-gray-200",children:H[e.id]})}),t.jsx("div",{className:"text-[10px] text-gray-300 text-right mt-1",children:new Date(e.created_at).toLocaleTimeString()})]}),ee===e.id&&t.jsxs("div",{className:"absolute -top-14 right-0 bg-white dark:bg-gray-800 shadow-lg rounded-xl p-2 flex space-x-2 z-30 border animate-fade-in",children:[t.jsx("button",{onClick:()=>L(e.id,"👍"),className:"p-1 rounded hover:bg-primary-100",title:"Reaccionar",children:"👍"}),t.jsx("button",{onClick:()=>L(e.id,"😂"),className:"p-1 rounded hover:bg-primary-100",title:"Reaccionar",children:"😂"}),t.jsx("button",{onClick:()=>L(e.id,"❤️"),className:"p-1 rounded hover:bg-primary-100",title:"Reaccionar",children:"❤️"}),t.jsx("button",{onClick:()=>ce(e),className:"p-1 rounded hover:bg-primary-100",title:"Responder",children:"↩️"}),l&&t.jsx("button",{onClick:()=>re(e),className:"p-1 rounded hover:bg-red-100",title:"Eliminar",children:"🗑️"})]})]},e.id)}),t.jsx("div",{ref:G})]}),N&&t.jsxs("div",{className:"flex items-center gap-2 mb-2 bg-blue-50 rounded px-3 py-1",children:[t.jsxs("span",{className:"text-xs truncate",children:["Respondiendo a: ",(J=N.content)==null?void 0:J.slice(0,40),"..."]}),t.jsx("button",{onClick:()=>_(null),className:"ml-auto text-gray-400 hover:text-red-500",children:"✕"})]}),t.jsxs("form",{onSubmit:e=>{ne(e),_(null)},className:"p-2 border-t flex gap-2 items-center relative bg-white sticky bottom-0 z-20 md:rounded-b-xl",children:[t.jsx("input",{ref:E,type:"file",accept:"image/*,video/*",className:"hidden",onChange:e=>F(e,"media"),disabled:$}),t.jsx("input",{ref:D,type:"file",accept:"audio/*",className:"hidden",onChange:e=>F(e,"music"),disabled:$}),t.jsx("input",{ref:A,type:"file",accept:".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation",className:"hidden",onChange:e=>F(e,"doc"),disabled:$}),t.jsx("button",{type:"button",className:"p-2 rounded hover:bg-gray-100 text-xl","aria-label":"Más opciones",onClick:()=>q(e=>!e),tabIndex:-1,children:t.jsx(me,{className:"w-5 h-5"})}),U&&t.jsxs("div",{className:"absolute bottom-12 left-0 z-50 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg p-2 flex flex-col gap-2 min-w-[180px] animate-fade-in",children:[t.jsxs("button",{type:"button",className:"flex items-center gap-2 p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-800",onClick:()=>X("media"),children:[t.jsx(xe,{className:"w-5 h-5 text-blue-500"})," Foto/Video"]}),t.jsxs("button",{type:"button",className:"flex items-center gap-2 p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-800",onClick:()=>X("music"),children:[t.jsx(fe,{className:"w-5 h-5 text-green-500"})," Música"]}),t.jsxs("button",{type:"button",className:"flex items-center gap-2 p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-800",onClick:()=>X("doc"),children:[t.jsx(be,{className:"w-5 h-5 text-yellow-500"})," Documento"]})]}),t.jsx("button",{type:"button",className:"p-2 rounded hover:bg-gray-100 text-xl","aria-label":"Emojis",onClick:()=>r(e=>!e),tabIndex:-1,children:"😊"}),c&&t.jsx("div",{className:"absolute bottom-12 left-12 z-50",children:t.jsx(pe,{data:he,onEmojiSelect:oe,theme:"light"})}),t.jsx("input",{className:"flex-1 border rounded px-3 py-2 bg-white text-black focus:outline-none focus:ring-2 focus:ring-blue-400 text-base md:text-lg",value:h,onChange:e=>g(e.target.value),placeholder:"Escribe un mensaje..."}),h.trim()?t.jsx("button",{type:"submit",className:"bg-blue-700 text-white px-4 py-1 rounded hover:bg-blue-800 transition",children:"Enviar"}):t.jsxs("div",{className:"relative",children:[t.jsx("button",{type:"button",className:`p-2 rounded hover:bg-gray-100 text-xl ${T?"bg-red-100":""}`,"aria-label":"Grabar audio",onMouseDown:V,onTouchStart:V,onMouseMove:W,onTouchMove:W,onMouseUp:Z,onTouchEnd:Z,onMouseLeave:B,onTouchCancel:B,tabIndex:-1,children:t.jsx(ge,{className:"w-5 h-5"})}),le()]}),d&&t.jsx("div",{className:"absolute bottom-14 right-0 z-50 w-[98vw] max-w-xs sm:max-w-sm md:max-w-md",children:t.jsx(ve,{ref:R,onAudioReady:ie,folder:"chat-audio"})})]})]})};export{Re as C};
