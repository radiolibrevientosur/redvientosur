import{b as R,r as i,j as e,s as c,a as s}from"./index-CSAYQrjP.js";const T=["General","Arte","Música","Cine","Danza","Literatura"],F=({onSuccess:y})=>{const{user:l}=R(),[p,N]=i.useState(""),[C,w]=i.useState(""),[m,E]=i.useState(""),[k,d]=i.useState(""),[S,P]=i.useState("General"),[o,f]=i.useState(!1),[x,h]=i.useState(0),[I,g]=i.useState(null),[U,t]=i.useState(""),D=async r=>{var _;const n=(_=r.target.files)==null?void 0:_[0];if(t(""),!n)return;g(URL.createObjectURL(n)),h(0);const u=`event-images/${Date.now()}_${n.name}`,b=setInterval(()=>{h(j=>j>=90?(clearInterval(b),j):j+10)},100),{error:v}=await c.storage.from("event-images").upload(u,n,{upsert:!0});if(clearInterval(b),h(100),v){t("Error al subir la imagen. Intenta con otro archivo."),s.error("Error al subir la imagen"),g(null),d("");return}const{data:a}=c.storage.from("event-images").getPublicUrl(u);d(a.publicUrl),s.success("Imagen subida correctamente")},L=async r=>{var n;if(r.preventDefault(),t(""),!l){t("Debes iniciar sesión para publicar un blog"),s.error("Debes iniciar sesión para publicar un blog");return}if(!p.trim()||!m.trim()){t("El título y el contenido son obligatorios"),s.error("El título y el contenido son obligatorios");return}f(!0);try{const{data:u,error:b}=await c.from("usuarios").select("id").eq("id",l.id).single();(b||!u)&&await c.from("usuarios").insert([{id:l.id,email:l.email,nombre_usuario:l.username||((n=l.email)==null?void 0:n.split("@")[0])||"usuario",nombre_completo:l.displayName||l.username||l.email||"Usuario"}]);const v={titulo:p.trim(),contenido:m.trim(),excerpt:C.trim()||m.substring(0,120),imagen_portada:k||null,categoria:S||null,tipo:"blog",autor_id:l.id},{error:a}=await c.from("publicaciones").insert([v]);if(a){a.code==="23505"||a.message&&a.message.includes("unique_blog_title_per_author")?(t("Ya existe un blog con este título. Cambia el título e inténtalo de nuevo."),s.error("Ya existe un blog con este título.")):a.code==="42501"||a.message&&a.message.toLowerCase().includes("row level security")?(t("No tienes permisos para crear este blog."),s.error("No tienes permisos para crear este blog.")):a.message&&a.message.toLowerCase().includes("null value")?(t("Faltan campos obligatorios. Revisa el formulario."),s.error("Faltan campos obligatorios.")):a.message&&a.message.includes("foreign key constraint")?(t("Tu perfil no está correctamente registrado. Intenta cerrar sesión y volver a entrar."),s.error("Tu perfil no está correctamente registrado.")):(t(a.message||"Error al publicar el blog"),s.error(a.message||"Error al publicar el blog")),f(!1);return}s.success("¡Blog publicado exitosamente!"),N(""),w(""),E(""),d(""),g(null),y&&y()}catch{t("Error al publicar el blog"),s.error("Error al publicar el blog")}finally{f(!1)}};return e.jsxs("form",{onSubmit:L,className:"space-y-4",autoComplete:"off",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block font-medium",children:"Título *"}),e.jsx("input",{type:"text",value:p,onChange:r=>N(r.target.value),className:"input w-full",required:!0,maxLength:80,placeholder:"Título atractivo para tu blog",disabled:o})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block font-medium",children:"Resumen"}),e.jsx("textarea",{value:C,onChange:r=>w(r.target.value),className:"input w-full",rows:2,maxLength:120,placeholder:"Breve resumen (máx. 120 caracteres)",disabled:o})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block font-medium",children:"Contenido *"}),e.jsx("textarea",{value:m,onChange:r=>E(r.target.value),className:"input w-full",rows:8,required:!0,placeholder:"Comparte tu historia, experiencia o reflexión...",disabled:o})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block font-medium",children:"Imagen de portada"}),e.jsx("input",{type:"file",accept:"image/*",onChange:D,disabled:o}),I&&e.jsxs("div",{className:"mt-2 relative rounded-lg overflow-hidden",children:[e.jsx("img",{src:I,alt:"Previsualización",className:"w-full max-h-48 object-cover rounded-lg border"}),x>0&&x<100&&e.jsx("div",{className:"absolute bottom-0 left-0 right-0 h-2 bg-primary-100",children:e.jsx("div",{className:"h-2 bg-primary-600",style:{width:`${x}%`}})}),e.jsx("button",{type:"button",onClick:()=>{g(null),d("")},className:"absolute top-2 right-2 bg-gray-900/70 text-white p-1 rounded-full",children:"✕"})]}),U&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:U})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block font-medium",children:"Categoría"}),e.jsx("select",{value:S,onChange:r=>P(r.target.value),className:"input w-full",disabled:o,children:T.map(r=>e.jsx("option",{value:r,children:r},r))})]}),e.jsxs("button",{type:"submit",disabled:o,className:"btn btn-primary flex items-center","aria-busy":o,children:[o?e.jsx("span",{className:"loader mr-2"}):null,o?"Publicando...":"Publicar blog"]})]})};export{F as C};
