import{c as Y,r as a,j as e,s as I,a as S,b as Z,d as V,I as ee}from"./index-CSAYQrjP.js";import{u as te}from"./postStore-D7vSN7Il.js";import{M as q,A as ae,a as re,F as se}from"./AudioRecorder-CD0syO5y.js";import{$ as ne,d as le}from"./native-Cg9DKGTJ.js";import{S as oe}from"./send-Dk2ChbBw.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=Y("Paperclip",[["path",{d:"m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48",key:"1u3ebp"}]]),ce=({onFileSelect:l,onCancel:p,folder:L="media"})=>{const[n,v]=a.useState(null),[w,r]=a.useState(null),[x,s]=a.useState(0),[C,o]=a.useState(!1),b=a.useRef(null),i=async j=>{var d;const c=((d=j.target.files)==null?void 0:d[0])||null;if(v(c),c){c.type.startsWith("image/")?r(URL.createObjectURL(c)):r(null),o(!0),s(0);try{const g=c.name.split(".").pop(),k=`${L}/${Date.now()}_${Math.random().toString(36).substring(2,8)}.${g}`;for(let h=1;h<=90;h+=10)await new Promise(M=>setTimeout(M,60)),s(h);const{error:f}=await I.storage.from("media").upload(k,c);if(s(100),o(!1),f)throw f;const{data:T}=I.storage.from("media").getPublicUrl(k);l(T.publicUrl),S.success("Archivo subido correctamente")}catch{o(!1),s(0),l(null),S.error("Error al subir archivo")}}else r(null),o(!1),s(0),l(null)},P=()=>{v(null),r(null),s(0),o(!1),l(null),p&&p(),b.current&&(b.current.value="")};return e.jsxs("div",{className:"space-y-2",children:[e.jsx("input",{ref:b,type:"file",onChange:i,disabled:C,className:"block",style:{display:"none"}}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("button",{type:"button",className:"p-2 rounded-full bg-gray-100 hover:bg-primary-100 text-gray-600 hover:text-primary-600 focus:outline-none focus:ring-2 focus:ring-primary-400",onClick:()=>{var j;return(j=b.current)==null?void 0:j.click()},disabled:C,"aria-label":"Seleccionar archivo",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.586-6.586a4 4 0 10-5.656-5.656l-6.586 6.586a6 6 0 108.485 8.485l6.586-6.586"})})}),n&&e.jsx("button",{type:"button",onClick:P,className:"btn btn-secondary btn-sm",children:"Cancelar"})]}),w&&e.jsx("img",{src:w,alt:"preview",className:"max-h-40 rounded"}),n&&!w&&e.jsxs("div",{className:"text-xs text-gray-500",children:["Archivo seleccionado: ",n.name]}),C&&e.jsx("div",{className:"w-full bg-gray-200 rounded h-2",children:e.jsx("div",{className:"bg-primary-500 h-2 rounded",style:{width:`${x}%`}})})]})},de=a.forwardRef(({onVideoReady:l,folder:p="media"},L)=>{const[n,v]=a.useState(!1),[w,r]=a.useState(!1),[x,s]=a.useState(0),[C,o]=a.useState(0),[b,i]=a.useState(null),[P,j]=a.useState(!1),[c,d]=a.useState(null),g=a.useRef(null),k=a.useRef([]),f=a.useRef(null),T=a.useRef(null),h=a.useRef(null),M=async()=>{i(null),o(0),s(0),r(!1);const y=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});h.current=y,T.current&&(T.current.srcObject=y,T.current.play());const N=new window.MediaRecorder(y);g.current=N,k.current=[],N.ondataavailable=R=>{k.current.push(R.data)},N.onstop=async()=>{const R=new Blob(k.current,{type:"video/webm"});r(!0),s(0);try{const $=`${p}/video_${Date.now()}_${Math.random().toString(36).substring(2,8)}.webm`;for(let E=1;E<=90;E+=10)await new Promise(B=>setTimeout(B,60)),s(E);const{error:U}=await I.storage.from("media").upload($,R);if(s(100),r(!1),U)throw U;const{data:D}=I.storage.from("media").getPublicUrl($);i(null),l(D.publicUrl),S.success("Video subido correctamente")}catch{r(!1),s(0),i(null),l(null),S.error("Error al subir video")}h.current&&h.current.getTracks().forEach($=>$.stop())},N.start(),v(!0),f.current=setInterval(()=>o(R=>R+1),1e3)},A=()=>{g.current&&n&&(v(!1),f.current&&clearInterval(f.current),g.current.onstop=()=>{const y=new Blob(k.current,{type:"video/webm"});d(URL.createObjectURL(y)),j(!0),h.current&&h.current.getTracks().forEach(N=>N.stop())},g.current.stop())},F=async()=>{if(j(!1),!!c){r(!0),s(0);try{const y=await fetch(c).then(U=>U.blob()),N=`${p}/video_${Date.now()}_${Math.random().toString(36).substring(2,8)}.webm`;for(let U=1;U<=90;U+=10)await new Promise(D=>setTimeout(D,60)),s(U);const{error:R}=await I.storage.from("media").upload(N,y);if(s(100),r(!1),R)throw R;const{data:$}=I.storage.from("media").getPublicUrl(N);i(null),d(null),l($.publicUrl),S.success("Video subido correctamente")}catch{r(!1),s(0),i(null),d(null),l(null),S.error("Error al subir video")}}},z=()=>{j(!1),i(null),d(null),o(0),s(0),r(!1),l(null),f.current&&clearInterval(f.current)},u=()=>{v(!1),i(null),d(null),o(0),s(0),r(!1),l(null),f.current&&clearInterval(f.current),g.current&&g.current.state!=="inactive"&&g.current.stop(),h.current&&h.current.getTracks().forEach(y=>y.stop())};return a.useImperativeHandle(L,()=>({startRecording:M,stopRecording:A,cancelRecording:u,isRecording:()=>n,isUploading:()=>w})),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex gap-2 items-center",children:[!n&&!w&&!P&&e.jsx("button",{type:"button",onClick:M,className:"btn btn-primary btn-sm",children:"Grabar video"}),n&&!P&&e.jsx("button",{type:"button",onClick:A,className:"btn btn-danger btn-sm animate-pulse",children:"Detener"}),n&&!P&&e.jsxs("span",{className:"text-red-500 font-mono animate-pulse",children:[C,"s"]}),(b||n||w)&&!P&&e.jsx("button",{type:"button",onClick:u,className:"btn btn-secondary btn-sm",children:"Cancelar"})]}),P&&c&&e.jsxs("div",{className:"flex flex-col items-center gap-3 animate-fade-in bg-white dark:bg-gray-900 rounded-xl shadow-lg p-4 border border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsx("span",{className:"text-2xl font-bold text-primary-600 dark:text-primary-400 animate-bounce",children:"¡Revisa tu video!"}),e.jsx("span",{className:"text-base text-gray-700 dark:text-gray-200",children:"¿Quieres enviarlo o descartarlo?"})]}),e.jsx("video",{src:c,controls:!0,className:"w-full my-2 rounded-lg shadow",style:{maxHeight:240}}),e.jsxs("div",{className:"flex gap-4 mt-2",children:[e.jsxs("button",{type:"button",onClick:F,className:"btn btn-success btn-lg flex items-center gap-2 animate-bounce",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})}),"Enviar"]}),e.jsxs("button",{type:"button",onClick:z,className:"btn btn-danger btn-lg flex items-center gap-2 animate-shake",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})}),"Descartar"]})]}),e.jsx("button",{type:"button",onClick:M,className:"btn btn-primary btn-xs mt-2 animate-fade-in",children:"Regrabar"})]}),b&&!n&&!w&&!P&&e.jsxs("div",{className:"space-y-1 relative group",children:[e.jsx("video",{src:b,controls:!0,className:"w-full rounded-lg",style:{maxHeight:240}}),e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsxs("button",{type:"button",onClick:()=>{i(null),d&&d(null),l(null),S("Nota de video eliminada")},className:"btn btn-danger btn-xs flex items-center gap-1 animate-shake",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})}),"Descartar"]}),e.jsx("button",{type:"button",onClick:M,className:"btn btn-primary btn-xs",children:"Regrabar"})]})]}),e.jsx("video",{ref:T,className:"w-full rounded-lg",autoPlay:!0,muted:!0,playsInline:!0,style:{display:n?"block":"none",maxHeight:240}}),w&&e.jsx("div",{className:"w-full bg-gray-200 rounded h-2",children:e.jsx("div",{className:"bg-primary-500 h-2 rounded",style:{width:`${x}%`}})})]})}),pe=({onSuccess:l})=>{const[p,L]=a.useState(""),[n,v]=a.useState(""),[w,r]=a.useState("text"),[x,s]=a.useState(!1),C=a.useRef(null),o=a.useRef(null),[b,i]=a.useState(!1),[P,j]=a.useState(!1),[c,d]=a.useState(!1),[g,k]=a.useState(!1),[f,T]=a.useState(!1),[h,M]=a.useState(!1),[A,F]=a.useState(null),z=a.useRef(null),{user:u}=Z(),{addPost:y}=te(),N=async t=>{if(t.preventDefault(),!u){S.error("Debes iniciar sesión para crear una publicación");return}if(!p.trim()&&!n){S.error("Por favor, agrega contenido o un archivo");return}s(!0);try{await y({userId:u.id,type:w,content:p.trim(),mediaUrl:n||void 0,isFavorite:!1}),L(""),v(""),r("text"),S.success("¡Publicación creada exitosamente!"),l&&l()}catch(m){S.error("Error al crear la publicación"),console.error("Failed to create post:",m)}finally{s(!1)}},R=t=>{v(t||""),t?t.match(/\.(jpg|jpeg|png|gif)$/i)?r("image"):t.match(/\.(mp4|webm|mov)$/i)?r("video"):t.match(/\.(mp3|wav|ogg)$/i)?r("audio"):r("document"):r("text")},$=t=>{v(t||""),r(t?"audio":"text"),d(!1),i(!1)},U=t=>{v(t||""),r(t?"video":"text"),k(!1)},D=()=>{d(!0),j(!1),k(!1),i(!0),window.navigator.vibrate&&window.navigator.vibrate([50,30,50]),setTimeout(()=>{var t;(t=C.current)==null||t.startRecording()},50)},E=()=>{var t;b&&((t=C.current)==null||t.stopRecording(),i(!1))},B=()=>{var t;b&&((t=C.current)==null||t.cancelRecording(),i(!1))},G=()=>{k(!0),j(!1),d(!1),setTimeout(()=>{var t;(t=o.current)==null||t.startRecording()},50)},_=()=>{var t;(t=o.current)==null||t.stopRecording()},O=()=>{var t;(t=o.current)==null||t.cancelRecording()},J=t=>{var m,H;L(p+(t.native||((H=(m=t.skins)==null?void 0:m[0])==null?void 0:H.native)||"")),T(!1)},K=()=>{M(!0),F(null)},W=t=>{F(t),setTimeout(()=>{var m;return(m=z.current)==null?void 0:m.click()},200)},X=t=>{var Q;const m=(Q=t.target.files)==null?void 0:Q[0];if(!m)return;const H=URL.createObjectURL(m);R(H),M(!1),F(null)};return e.jsx("div",{className:"feed-item mb-4 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 shadow-sm",children:e.jsxs("form",{onSubmit:N,children:[e.jsx("div",{className:"p-4 pb-2",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx("div",{className:"avatar",children:e.jsx("img",{src:u==null?void 0:u.avatar,alt:u==null?void 0:u.displayName,className:"avatar-img"})}),e.jsx("textarea",{placeholder:`Hola ${(u==null?void 0:u.displayName)||""} ¿Qué está pasando?`,value:p,onChange:t=>L(t.target.value),className:"flex-1 p-4 text-lg text-gray-900 dark:text-white bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-2xl focus:ring-2 focus:ring-primary-500 focus:border-primary-500 shadow-sm resize-none min-h-[48px] max-h-[160px] transition-all placeholder-gray-400 dark:placeholder-gray-500",rows:2,"aria-label":"Contenido de la publicación",required:!n,disabled:x,style:{height:"auto",boxShadow:"0 2px 8px 0 rgba(0,0,0,0.04)"},onInput:t=>{const m=t.target;m.style.height="auto",m.style.height=m.scrollHeight+"px"}})]})}),e.jsxs("div",{className:"px-4 py-2 flex items-end border-t border-gray-100 dark:border-gray-800 bg-white dark:bg-gray-900 rounded-b-2xl",children:[e.jsx("button",{type:"button",className:"p-2 rounded-full text-gray-600 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-800 mr-1",onClick:()=>T(t=>!t),"aria-label":"Insertar emoji",disabled:x,children:e.jsx("span",{role:"img","aria-label":"emoji",children:"😊"})}),e.jsx("button",{type:"button",className:"p-2 rounded-full text-gray-600 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-800 mr-1",onClick:K,"aria-label":"Adjuntar archivo",disabled:x,children:e.jsx(ie,{className:"h-5 w-5"})}),e.jsx("div",{className:"flex-1"}),p.trim()||n?e.jsx("button",{type:"submit",disabled:x||!p.trim()&&!n,className:"btn btn-primary p-2 rounded-full flex items-center justify-center ml-1","aria-busy":x,children:x?e.jsx("span",{className:"loader h-5 w-5"}):e.jsx(oe,{className:"h-5 w-5"})}):e.jsxs("button",{type:"button",className:`relative p-2 rounded-full text-gray-600 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-800 ml-1 transition-all duration-200
                ${c?"bg-red-200 text-red-600 ring-4 ring-red-400/30 animate-pulse":""}`,onMouseDown:D,onMouseUp:E,onMouseLeave:B,onTouchStart:D,onTouchEnd:E,onTouchCancel:B,"aria-label":"Grabar nota de voz",disabled:x,children:[b&&e.jsx("span",{className:"absolute inset-0 rounded-full border-2 border-red-400 animate-ping"}),e.jsx(q,{className:"h-5 w-5 relative z-10"})]}),e.jsx("button",{type:"button",className:`p-2 rounded-full text-gray-600 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-800 ml-1 ${g?"bg-blue-200 text-blue-600":""}`,onMouseDown:G,onMouseUp:_,onMouseLeave:O,onTouchStart:G,onTouchEnd:_,onTouchCancel:O,"aria-label":"Grabar nota de video",disabled:x,children:e.jsx(V,{className:"h-5 w-5"})})]}),P&&e.jsx("div",{className:"px-4 pb-2",children:e.jsx(ce,{onFileSelect:R})}),c&&e.jsxs("div",{className:"px-4 pb-2",children:[e.jsx(ae,{ref:C,onAudioReady:$}),b&&e.jsxs("div",{className:"text-red-600 font-bold mt-2 flex items-center gap-2",children:[e.jsx(q,{className:"h-4 w-4 animate-pulse"})," Grabando... Suelta para enviar, desliza fuera para cancelar"]})]}),g&&e.jsxs("div",{className:"px-4 pb-2",children:[e.jsx(de,{ref:o,onVideoReady:U}),e.jsxs("div",{className:"text-blue-600 font-bold mt-2 flex items-center gap-2",children:[e.jsx(V,{className:"h-4 w-4 animate-pulse"})," Grabando video... Suelta para enviar, desliza fuera para cancelar"]})]}),f&&e.jsx("div",{className:"fixed left-12 bottom-8 z-50 animate-slide-down shadow-2xl rounded-2xl bg-white dark:bg-gray-900 border border-primary-200 dark:border-primary-700",children:e.jsx(ne,{data:le,onEmojiSelect:J,theme:"auto"})}),h&&e.jsx("div",{className:"fixed inset-0 z-50 bg-black/40 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white dark:bg-gray-900 rounded-xl shadow-lg p-6 w-full max-w-xs flex flex-col items-center gap-4 relative",children:[e.jsx("button",{className:"absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-2xl",onClick:()=>M(!1),children:"×"}),e.jsx("h3",{className:"text-lg font-bold mb-2",children:"¿Qué quieres adjuntar?"}),e.jsxs("div",{className:"flex flex-col gap-3 w-full",children:[e.jsxs("button",{type:"button",className:"w-full flex items-center gap-2 justify-center rounded-full py-2 text-base font-semibold bg-white dark:bg-gray-800 border border-primary-200 dark:border-gray-700 shadow-sm hover:bg-primary-50 dark:hover:bg-gray-700 transition-colors text-primary-700 dark:text-primary-200",onClick:()=>W("media"),children:[e.jsx(ee,{className:"h-5 w-5"})," Foto/Video"]}),e.jsxs("button",{type:"button",className:"w-full flex items-center gap-2 justify-center rounded-full py-2 text-base font-semibold bg-white dark:bg-gray-800 border border-primary-200 dark:border-gray-700 shadow-sm hover:bg-primary-50 dark:hover:bg-gray-700 transition-colors text-primary-700 dark:text-primary-200",onClick:()=>W("music"),children:[e.jsx(re,{className:"h-5 w-5"})," Música"]}),e.jsxs("button",{type:"button",className:"w-full flex items-center gap-2 justify-center rounded-full py-2 text-base font-semibold bg-white dark:bg-gray-800 border border-primary-200 dark:border-gray-700 shadow-sm hover:bg-primary-50 dark:hover:bg-gray-700 transition-colors text-primary-700 dark:text-primary-200",onClick:()=>W("document"),children:[e.jsx(se,{className:"h-5 w-5"})," Documento"]})]}),e.jsx("input",{ref:z,type:"file",accept:A==="media"?"image/*,video/*":A==="music"?"audio/*":A==="document"?".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip,.rar,.csv":"*/*",style:{display:"none"},onChange:X})]})})]})})};export{pe as C};
