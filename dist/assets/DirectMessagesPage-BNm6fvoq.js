import{b as S,r as d,j as e,s as c}from"./index-COvD-dsj.js";const q=["Primario","General","Solicitudes"],$=()=>{const{user:a}=S(),[_,y]=d.useState("General"),[f,g]=d.useState([]),[t,N]=d.useState(null),[h,b]=d.useState([]),[u,v]=d.useState(""),[p,m]=d.useState(!1),[x,j]=d.useState(!1);d.useEffect(()=>{if(!a)return;m(!0),(async()=>{const{data:l}=await c.from("messages").select("*").or(`sender_id.eq.${a.id},receiver_id.eq.${a.id}`);if(!l){g([]),m(!1);return}const n={};for(const r of l){const i=r.sender_id===a.id?r.receiver_id:r.sender_id;if(!n[i]){const{data:o}=await c.from("usuarios").select("nombre_usuario,avatar_url").eq("id",i).single();n[i]={user_id:i,username:(o==null?void 0:o.nombre_usuario)||"Usuario",avatar:(o==null?void 0:o.avatar_url)||"/default-avatar.png",last_message:r.content,last_time:r.created_at,unread_count:0}}new Date(r.created_at)>new Date(n[i].last_time)&&(n[i].last_message=r.content,n[i].last_time=r.created_at),r.receiver_id===a.id&&!r.read&&(n[i].unread_count+=1)}g(Object.values(n).sort((r,i)=>new Date(i.last_time).getTime()-new Date(r.last_time).getTime())),m(!1)})()},[a]),d.useEffect(()=>{if(!a||!t)return;j(!0),(async()=>{const{data:l}=await c.from("messages").select("*").or(`and(sender_id.eq.${a.id},receiver_id.eq.${t.user_id}),and(sender_id.eq.${t.user_id},receiver_id.eq.${a.id})`).order("created_at",{ascending:!0});b(l||[]),j(!1),await c.from("messages").update({read:!0}).eq("receiver_id",a.id).eq("sender_id",t.user_id).eq("read",!1)})()},[a,t]);const w=async s=>{if(s.preventDefault(),!a||!t||!u.trim())return;await c.from("messages").insert({sender_id:a.id,receiver_id:t.user_id,content:u.trim(),read:!1}),v("");const{data:l}=await c.from("messages").select("*").or(`and(sender_id.eq.${a.id},receiver_id.eq.${t.user_id}),and(sender_id.eq.${t.user_id},receiver_id.eq.${a.id})`).order("created_at",{ascending:!0});b(l||[])};return e.jsxs("div",{className:"flex h-[80vh] bg-white rounded-lg shadow overflow-hidden",children:[e.jsxs("div",{className:"w-80 border-r flex flex-col",children:[e.jsx("div",{className:"p-4 font-bold text-lg",children:"Tu bandeja"}),e.jsx("div",{className:"flex space-x-2 px-4 mb-2",children:q.map(s=>e.jsx("button",{className:`px-3 py-1 rounded-full text-sm font-medium ${_===s?"bg-blue-500 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>y(s),children:s},s))}),e.jsx("div",{className:"px-4 mb-2",children:e.jsx("input",{type:"text",placeholder:"Buscar...",className:"w-full px-3 py-2 rounded bg-gray-100 focus:outline-none",disabled:p})}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:p?e.jsx("div",{className:"p-4 text-gray-400",children:"Cargando..."}):f.length===0?e.jsx("div",{className:"p-4 text-gray-400",children:"No hay conversaciones."}):f.map(s=>e.jsxs("div",{className:`flex items-center px-4 py-3 cursor-pointer hover:bg-gray-100 ${(t==null?void 0:t.user_id)===s.user_id?"bg-gray-200":""}`,onClick:()=>N(s),children:[e.jsx("img",{src:s.avatar,alt:s.username,className:"w-10 h-10 rounded-full mr-3"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-semibold flex items-center",children:[s.username,s.unread_count>0&&e.jsx("span",{className:"ml-2 w-2 h-2 bg-blue-500 rounded-full inline-block"})]}),e.jsx("div",{className:"text-xs text-gray-500 truncate max-w-[180px]",children:s.last_message})]}),e.jsx("div",{className:"text-xs text-gray-400 ml-2",children:new Date(s.last_time).toLocaleDateString()})]},s.user_id))}),e.jsx("div",{className:"p-4 border-t",children:e.jsx("button",{className:"w-full bg-blue-500 text-white py-2 rounded font-semibold hover:bg-blue-600 transition",children:"Enviar mensaje"})})]}),e.jsx("div",{className:"flex-1 flex flex-col",children:t?e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"border-b px-6 py-4 font-bold text-lg flex items-center",children:[e.jsx("img",{src:t.avatar,alt:"avatar",className:"w-8 h-8 rounded-full mr-3"}),t.username]}),e.jsx("div",{className:"flex-1 overflow-y-auto px-6 py-4 space-y-4 bg-gray-50",children:x?e.jsx("div",{className:"text-gray-400",children:"Cargando mensajes..."}):h.length===0?e.jsx("div",{className:"text-gray-400",children:"No hay mensajes aún."}):h.map(s=>e.jsx("div",{className:`flex ${a&&s.sender_id===a.id?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-xs px-4 py-2 rounded-lg shadow text-sm ${a&&s.sender_id===a.id?"bg-blue-500 text-white":"bg-white border"}`,children:[e.jsx("div",{children:s.content}),e.jsx("div",{className:"text-xs text-gray-300 mt-1 text-right",children:new Date(s.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})},s.id))}),e.jsxs("form",{className:"flex items-center p-4 border-t bg-white",onSubmit:w,children:[e.jsx("input",{type:"text",className:"flex-1 px-4 py-2 rounded-full border bg-gray-100 focus:outline-none",placeholder:"Escribe un mensaje...",value:u,onChange:s=>v(s.target.value),disabled:x}),e.jsx("button",{type:"submit",className:"ml-2 bg-blue-500 text-white px-4 py-2 rounded-full font-semibold hover:bg-blue-600 transition",disabled:x||!u.trim(),children:"Enviar"})]})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-full",children:[e.jsx("div",{className:"rounded-full border-4 border-gray-200 p-6 mb-4",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-12 w-12 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 10h.01M12 10h.01M16 10h.01M21 12c0 4.418-4.03 8-9 8s-9-3.582-9-8 4.03-8 9-8 9 3.582 9 8z"})})}),e.jsx("div",{className:"text-xl font-bold mb-2",children:"Tus mensajes"}),e.jsx("div",{className:"text-gray-500 mb-4",children:"Envía fotos y mensajes privados a un amigo o grupo"}),e.jsx("button",{className:"bg-blue-500 text-white px-4 py-2 rounded font-semibold hover:bg-blue-600 transition",children:"Enviar mensaje"})]})})]})};export{$ as default};
