import{r as a,s as f,b as ue,j as t,t as me,I as xe,a as Z,v as he,w as pe}from"./index-CSAYQrjP.js";import{$ as fe,d as be}from"./native-Cg9DKGTJ.js";import{a as ge,F as ve,M as we,A as je}from"./AudioRecorder-CD0syO5y.js";function ye(n){const[b,j]=a.useState([]),[i,m]=a.useState([]),[g,r]=a.useState(!1),y=a.useCallback(async()=>{r(!0);const{data:l,error:x}=await f.rpc("get_conversations",{user_id:n});!x&&l&&j(l),r(!1)},[n]),c=a.useCallback(async l=>{r(!0);const{data:x,error:h}=await f.from("messages").select("*").or(`and(sender_id.eq.${n},receiver_id.eq.${l}),and(sender_id.eq.${l},receiver_id.eq.${n})`).order("created_at",{ascending:!0});!h&&x&&m(x),r(!1)},[n]),u=a.useCallback(async(l,x)=>{const{data:h,error:v}=await f.from("messages").insert({sender_id:n,receiver_id:l,content:x}).select().single();return!v&&h&&m(R=>[...R,h]),{data:h,error:v}},[n]);return a.useEffect(()=>{const l=f.channel("messages").on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},x=>{const h=x.new;(h.sender_id===n||h.receiver_id===n)&&m(v=>[...v,h])}).subscribe();return()=>{f.removeChannel(l)}},[n]),{conversations:b,messages:i,loading:g,fetchConversations:y,fetchMessages:c,sendMessage:u}}const Ne=({otherUserId:n,otherUserName:b,otherUserAvatar:j})=>{var J;const{user:i}=ue(),{messages:m,fetchMessages:g,sendMessage:r,loading:y}=ye((i==null?void 0:i.id)||""),[c,u]=a.useState(""),[l,x]=a.useState(!1),[h,v]=a.useState(!1),[R,O]=a.useState(null),[U,q]=a.useState(!1),[$,Y]=a.useState(!1),[ee,k]=a.useState(null),[H,te]=a.useState({}),[M,_]=a.useState(null),G=a.useRef(null),E=a.useRef(null),A=a.useRef(null),D=a.useRef(null),C=a.useRef(null),[T,P]=a.useState(!1),N=a.useRef(null),[z,S]=a.useState("none"),ae=60,se=60;a.useEffect(()=>{i!=null&&i.id&&n&&g(n)},[i,n,g]),a.useEffect(()=>{var e;(e=G.current)==null||e.scrollIntoView({behavior:"smooth"})},[m]);const ne=async e=>{if(e.preventDefault(),!(!c.trim()&&!R||y)){if(R)await r(n,R),O(null);else{const s=c.trim();i==null||i.id,new Date().toISOString(),M&&(M.id,M.content),await r(n,s),setTimeout(()=>{_(null)},100)}u("")}},oe=e=>{u(c+(e.native||"")),x(!1)},ie=async e=>{e&&(await r(n,e),O(null),u("")),v(!1)},L=e=>{var s,o,d;e==="media"&&((s=E.current)==null||s.click()),e==="music"&&((o=A.current)==null||o.click()),e==="doc"&&((d=D.current)==null||d.click())},X=async(e,s)=>{var d;const o=(d=e.target.files)==null?void 0:d[0];if(q(!1),!!o){Y(!0);try{const w=o.name.split(".").pop(),K=`${s==="media"?"chat-media":s==="music"?"chat-music":"chat-docs"}/${Date.now()}_${Math.random().toString(36).substring(2,8)}.${w}`,{error:Q}=await f.storage.from("media").upload(K,o);if(Q)throw Q;const{data:de}=f.storage.from("media").getPublicUrl(K);await r(n,de.publicUrl),Z.success("Archivo enviado")}catch{Z.error("Error al subir archivo")}finally{Y(!1),E.current&&(E.current.value=""),A.current&&(A.current.value=""),D.current&&(D.current.value="")}}},V=e=>{v(!0),P(!0),S("none");let s=0,o=0;"touches"in e&&e.touches.length>0?(s=e.touches[0].clientX,o=e.touches[0].clientY):"clientX"in e&&(s=e.clientX,o=e.clientY),N.current={x:s,y:o},setTimeout(()=>{var d;(d=C.current)==null||d.startRecording()},50)},W=e=>{if(!T||!N.current)return;let s=0,o=0;"touches"in e&&e.touches.length>0?(s=e.touches[0].clientX,o=e.touches[0].clientY):"clientX"in e&&(s=e.clientX,o=e.clientY);const d=s-N.current.x,w=o-N.current.y;d<-ae?S("left"):w<-se?S("up"):S("none")},le=()=>T?z==="left"?t.jsx("span",{className:"absolute left-0 bottom-14 text-xs bg-red-600 text-white px-2 py-1 rounded shadow animate-shake",children:"Desliza a la izquierda para cancelar"}):z==="up"?t.jsx("span",{className:"absolute right-0 bottom-14 text-xs bg-blue-600 text-white px-2 py-1 rounded shadow animate-bounce",children:"Desliza hacia arriba para previsualizar"}):t.jsx("span",{className:"absolute bottom-14 left-1/2 -translate-x-1/2 text-xs bg-gray-700 text-white px-2 py-1 rounded shadow",children:"Suelta para enviar"}):null,I=()=>{var e,s;P(!1),z==="left"?(e=C.current)==null||e.cancelRecording():(s=C.current)==null||s.stopRecording(),S("none"),N.current=null},B=()=>{var e;P(!1),(e=C.current)==null||e.cancelRecording(),S("none"),N.current=null},F=(e,s)=>{te(o=>({...o,[e]:s})),k(null)},re=e=>{_(e),k(null)},ce=async e=>{if(e.sender_id===(i==null?void 0:i.id)){if(await f.from("messages").delete().eq("id",e.id),Array.isArray(m)){const s=m.findIndex(o=>o.id===e.id);s!==-1&&m.splice(s,1)}k(null)}};return t.jsxs("div",{className:"flex flex-col h-full border rounded shadow bg-white max-w-full sm:max-w-md mx-auto w-full min-h-[80vh] sm:min-h-[500px] relative md:rounded-xl md:shadow-lg md:border md:bg-white",children:[t.jsxs("div",{className:"p-2 border-b font-semibold flex items-center gap-2 bg-white sticky top-0 z-10 min-h-[48px] sm:min-h-[56px] md:rounded-t-xl",children:[j&&t.jsx("img",{src:j,alt:b||n,className:"w-9 h-9 rounded-full object-cover"}),t.jsxs("span",{className:"truncate text-base sm:text-lg",children:["Chat con ",b||n]})]}),t.jsxs("div",{className:"flex-1 overflow-y-auto p-2 sm:p-4 space-y-2 bg-gray-50 hide-scrollbar min-h-[60vh] max-h-[70vh] md:rounded-b-xl",children:[y?t.jsx("div",{children:"Cargando mensajes..."}):m.map(e=>{var w;const s=e.content&&e.content.startsWith("http");let o=null;if(s){const p=e.content;p.match(/\.(jpg|jpeg|png|gif|webp)$/i)?o=t.jsx("img",{src:p,alt:"imagen adjunta",className:"max-w-[180px] max-h-40 rounded mb-1"}):p.match(/\.(mp4|webm|mov)$/i)?o=t.jsx("video",{src:p,controls:!0,className:"max-w-[180px] max-h-40 rounded mb-1"}):p.match(/\.(mp3|wav|ogg)$/i)?o=t.jsx("audio",{src:p,controls:!0,className:"w-full my-1"}):o=t.jsx("a",{href:p,target:"_blank",rel:"noopener noreferrer",className:"block text-blue-200 underline break-all mb-1",children:"Documento adjunto"})}const d=e.sender_id===(i==null?void 0:i.id);return t.jsxs("div",{className:"relative group",children:[t.jsxs("div",{className:`max-w-xs px-3 py-2 rounded-lg text-sm shadow-md ${d?"bg-blue-600 text-white ml-auto":"bg-gray-700 text-white mr-auto"}`,onContextMenu:p=>{p.preventDefault(),k(e.id)},onClick:()=>k(e.id),tabIndex:0,"aria-label":"Acciones de mensaje",children:[e.reply_to&&t.jsxs("div",{className:"text-xs text-blue-200 mb-1 border-l-2 border-blue-300 pl-2 italic",children:["Respondiendo a: ",(w=e.reply_to.content)==null?void 0:w.slice(0,40),"..."]}),s?o:e.content,H[e.id]&&t.jsx("div",{className:"mt-1 flex items-center gap-1",children:t.jsx("span",{className:"bg-white/80 text-black rounded-full px-2 py-0.5 text-base border border-gray-200",children:H[e.id]})}),t.jsx("div",{className:"text-[10px] text-gray-300 text-right mt-1",children:new Date(e.created_at).toLocaleTimeString()})]}),ee===e.id&&t.jsxs("div",{className:"absolute -top-14 right-0 bg-white dark:bg-gray-800 shadow-lg rounded-xl p-2 flex space-x-2 z-30 border animate-fade-in",children:[t.jsx("button",{onClick:()=>F(e.id,"👍"),className:"p-1 rounded hover:bg-primary-100",title:"Reaccionar",children:"👍"}),t.jsx("button",{onClick:()=>F(e.id,"😂"),className:"p-1 rounded hover:bg-primary-100",title:"Reaccionar",children:"😂"}),t.jsx("button",{onClick:()=>F(e.id,"❤️"),className:"p-1 rounded hover:bg-primary-100",title:"Reaccionar",children:"❤️"}),t.jsx("button",{onClick:()=>re(e),className:"p-1 rounded hover:bg-primary-100",title:"Responder",children:"↩️"}),d&&t.jsx("button",{onClick:()=>ce(e),className:"p-1 rounded hover:bg-red-100",title:"Eliminar",children:"🗑️"})]})]},e.id)}),t.jsx("div",{ref:G})]}),M&&t.jsxs("div",{className:"flex items-center gap-2 mb-2 bg-blue-50 rounded px-3 py-1",children:[t.jsxs("span",{className:"text-xs truncate",children:["Respondiendo a: ",(J=M.content)==null?void 0:J.slice(0,40),"..."]}),t.jsx("button",{onClick:()=>_(null),className:"ml-auto text-gray-400 hover:text-red-500",children:"✕"})]}),t.jsxs("form",{onSubmit:e=>{ne(e),_(null)},className:"p-2 border-t flex gap-2 items-center relative bg-white sticky bottom-0 z-20 md:rounded-b-xl",children:[t.jsx("input",{ref:E,type:"file",accept:"image/*,video/*",className:"hidden",onChange:e=>X(e,"media"),disabled:$}),t.jsx("input",{ref:A,type:"file",accept:"audio/*",className:"hidden",onChange:e=>X(e,"music"),disabled:$}),t.jsx("input",{ref:D,type:"file",accept:".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation",className:"hidden",onChange:e=>X(e,"doc"),disabled:$}),t.jsx("button",{type:"button",className:"p-2 rounded hover:bg-gray-100 text-xl","aria-label":"Más opciones",onClick:()=>q(e=>!e),tabIndex:-1,children:t.jsx(me,{className:"w-5 h-5"})}),U&&t.jsxs("div",{className:"absolute bottom-12 left-0 z-50 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg p-2 flex flex-col gap-2 min-w-[180px] animate-fade-in",children:[t.jsxs("button",{type:"button",className:"flex items-center gap-2 p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-800",onClick:()=>L("media"),children:[t.jsx(xe,{className:"w-5 h-5 text-blue-500"})," Foto/Video"]}),t.jsxs("button",{type:"button",className:"flex items-center gap-2 p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-800",onClick:()=>L("music"),children:[t.jsx(ge,{className:"w-5 h-5 text-green-500"})," Música"]}),t.jsxs("button",{type:"button",className:"flex items-center gap-2 p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-800",onClick:()=>L("doc"),children:[t.jsx(ve,{className:"w-5 h-5 text-yellow-500"})," Documento"]})]}),t.jsx("button",{type:"button",className:"p-2 rounded hover:bg-gray-100 text-xl","aria-label":"Emojis",onClick:()=>x(e=>!e),tabIndex:-1,children:"😊"}),l&&t.jsx("div",{className:"absolute bottom-12 left-12 z-50",children:t.jsx(fe,{data:be,onEmojiSelect:oe,theme:"light"})}),t.jsx("input",{className:"flex-1 border rounded px-3 py-2 bg-white text-black focus:outline-none focus:ring-2 focus:ring-blue-400 text-base md:text-lg",value:c,onChange:e=>u(e.target.value),placeholder:"Escribe un mensaje..."}),c.trim()?t.jsx("button",{type:"submit",className:"bg-blue-700 text-white px-4 py-1 rounded hover:bg-blue-800 transition",children:"Enviar"}):t.jsxs("div",{className:"relative",children:[t.jsx("button",{type:"button",className:`p-2 rounded hover:bg-gray-100 text-xl ${T?"bg-red-100":""}`,"aria-label":"Grabar audio",onMouseDown:V,onTouchStart:V,onMouseMove:W,onTouchMove:W,onMouseUp:I,onTouchEnd:I,onMouseLeave:B,onTouchCancel:B,tabIndex:-1,children:t.jsx(we,{className:"w-5 h-5"})}),le()]}),h&&t.jsx("div",{className:"absolute bottom-14 right-0 z-50 w-[98vw] max-w-xs sm:max-w-sm md:max-w-md",children:t.jsx(je,{ref:C,onAudioReady:ie,folder:"chat-audio"})})]})]})},Me=()=>{const[n,b]=a.useState(null),[j,i]=a.useState(void 0),[m,g]=a.useState(void 0),[r]=he();a.useEffect(()=>{const c=r.get("to"),u=r.get("name"),l=r.get("avatar");c&&(b(c),i(u||void 0),g(l||void 0))},[r]);const y=(c,u,l)=>{b(c),i(u),g(l)};return t.jsxs("div",{className:"flex h-[80vh] max-w-4xl mx-auto mt-6 border rounded shadow bg-white overflow-hidden",children:[t.jsxs("div",{className:"w-1/3 border-r bg-gray-50",children:[t.jsx("div",{className:"p-3 font-bold border-b",children:"Conversaciones"}),t.jsx(pe,{onSelectUser:(c,u,l)=>y(c,u,l)})]}),t.jsx("div",{className:"flex-1 flex flex-col",children:n?t.jsx(Ne,{otherUserId:n,otherUserName:j,otherUserAvatar:m}):t.jsx("div",{className:"flex-1 flex items-center justify-center text-gray-400",children:"Selecciona una conversación para comenzar a chatear"})})]})};export{Me as default};
