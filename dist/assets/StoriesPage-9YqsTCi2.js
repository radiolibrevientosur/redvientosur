import{c as G,e as J,r as o,j as e,m as k,A as K,H as X,M as Y,s as d,d as m}from"./index-CkCNI7dU.js";import{S as Z}from"./share-2-D6YOoNpV.js";import{C as ee,a as te}from"./chevron-right-BVamHRHT.js";/**
 * @license lucide-react v0.513.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ae=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]],re=G("circle-plus",ae),oe=()=>{var V,z;const{user:a}=J(),[x,w]=o.useState([]),[R,_]=o.useState(!0),[n,y]=o.useState(null),[u,S]=o.useState(0),[$,C]=o.useState(!1),[v,j]=o.useState(""),[f,L]=o.useState(null),[N,A]=o.useState(!1),[H,I]=o.useState(null),[U,P]=o.useState(""),[M,h]=o.useState("menu"),T=o.useRef(null);o.useEffect(()=>{(async()=>{_(!0);const{data:r,error:g}=await d.from("posts").select("id, autor_id, tipo, contenido, multimedia_url, creado_en, autor:usuarios(id, nombre_completo, avatar_url)").eq("tipo","story").order("creado_en",{ascending:!1});if(g){w([]),_(!1);return}const p=(r||[]).map(l=>{var i,s,c;return{id:l.id,userId:l.autor_id,userName:((i=l.autor)==null?void 0:i.nombre_completo)||"Usuario",userAvatar:((s=l.autor)==null?void 0:s.avatar_url)||"/default-avatar.png",imageUrl:((c=l.multimedia_url)==null?void 0:c[0])||"",description:l.contenido||"",createdAt:l.creado_en,likes:0,isViewed:!1}});w(p),_(!1)})()},[]);const B=(t,r)=>{y(t),S(r)},q=()=>{y(null)},O=t=>{t.stopPropagation(),u<x.length-1?(S(u+1),y(x[u+1])):q()},Q=t=>{t.stopPropagation(),u>0&&(S(u-1),y(x[u-1]))},E=async t=>{if(t.preventDefault(),!a||!v&&!f){m.error("Agrega una imagen o texto");return}A(!0);let r="";if(f){const p=f.name.split(".").pop(),l=`stories/${a.id}_${Date.now()}.${p}`,{data:i,error:s}=await d.storage.from("event-images").upload(l,f);if(s){m.error("Error al subir la imagen"),A(!1);return}const{data:c}=d.storage.from("event-images").getPublicUrl(l);r=c.publicUrl}const{error:g}=await d.from("posts").insert({autor_id:a.id,tipo:"story",contenido:v,multimedia_url:r?[r]:[]});if(g)m.error("Error al crear story");else{m.success("¡Story publicada!"),C(!1),j(""),L(null);const{data:p,error:l}=await d.from("posts").select("id, autor_id, tipo, contenido, multimedia_url, creado_en, autor:usuarios(id, nombre_completo, avatar_url)").eq("tipo","story").order("creado_en",{ascending:!1});if(!l){const i=(p||[]).map(s=>{var c,b,D;return{id:s.id,userId:s.autor_id,userName:((c=s.autor)==null?void 0:c.nombre_completo)||"Usuario",userAvatar:((b=s.autor)==null?void 0:b.avatar_url)||"/default-avatar.png",imageUrl:((D=s.multimedia_url)==null?void 0:D[0])||"",description:s.contenido||"",createdAt:s.creado_en,likes:0,isViewed:!1}});w(i)}}A(!1)},W=async t=>{if(!a)return m.error("Inicia sesión para dar like");I(t.id);const{data:r}=await d.from("reacciones_post").select("*").eq("post_id",t.id).eq("usuario_id",a.id).single();r?(await d.from("reacciones_post").delete().eq("post_id",t.id).eq("usuario_id",a.id),m("Like eliminado")):(await d.from("reacciones_post").insert({post_id:t.id,usuario_id:a.id,tipo:"like"}),m("¡Te gustó la story!")),I(null);const{data:g,error:p}=await d.from("posts").select("id, autor_id, tipo, contenido, multimedia_url, creado_en, autor:usuarios(id, nombre_completo, avatar_url)").eq("tipo","story").order("creado_en",{ascending:!1});if(!p){const l=(g||[]).map(i=>{var s,c,b;return{id:i.id,userId:i.autor_id,userName:((s=i.autor)==null?void 0:s.nombre_completo)||"Usuario",userAvatar:((c=i.autor)==null?void 0:c.avatar_url)||"/default-avatar.png",imageUrl:((b=i.multimedia_url)==null?void 0:b[0])||"",description:i.contenido||"",createdAt:i.creado_en,likes:0,isViewed:!1}});w(l)}},F=async t=>{!a||!U.trim()||(await d.from("comentarios_post").insert({post_id:t.id,autor_id:a.id,contenido:U.trim()}),m.success("Comentario enviado"),P(""))};return R?null:e.jsxs("div",{className:"space-y-6",children:[$&&e.jsx("div",{className:"fixed inset-0 z-50 bg-black/70 flex items-center justify-center",children:e.jsxs("div",{className:"relative bg-white dark:bg-gray-900 rounded-2xl shadow-2xl w-full max-w-xs sm:max-w-md flex flex-col items-center gap-4 p-6",children:[e.jsx("button",{type:"button",className:"absolute top-3 right-3 text-gray-400 hover:text-gray-700 text-2xl z-20",onClick:()=>{C(!1),h("menu"),j(""),L(null)},"aria-label":"Cerrar",children:"×"}),e.jsx("h3",{className:"text-lg font-bold mb-2 text-center w-full",children:"Crear historia"}),M==="menu"&&e.jsxs("div",{className:"flex flex-col gap-4 w-full",children:[e.jsx("button",{type:"button",className:"btn btn-primary w-full rounded-full py-2 text-base font-semibold",onClick:()=>h("text"),children:"Historia de texto"}),e.jsx("button",{type:"button",className:"btn btn-accent w-full rounded-full py-2 text-base font-semibold",onClick:()=>{h("photo"),setTimeout(()=>{var t;return(t=T.current)==null?void 0:t.click()},100)},children:"Historia de foto"})]}),M==="text"&&e.jsxs("form",{onSubmit:E,className:"flex flex-col items-center gap-4 w-full",children:[a&&e.jsxs("div",{className:"flex items-center gap-2 mb-2 w-full",children:[e.jsx("img",{src:a.avatar,alt:a.displayName,className:"w-10 h-10 rounded-full border-2 border-white shadow"}),e.jsx("span",{className:"font-semibold text-sm text-gray-800 dark:text-gray-100",children:(V=a.displayName)==null?void 0:V.split(" ")[0]})]}),e.jsx("textarea",{className:"w-full rounded border p-2 text-sm focus:ring-2 focus:ring-primary-500",placeholder:"¿Qué quieres compartir? (máx. 180 caracteres)",value:v,onChange:t=>j(t.target.value),rows:4,maxLength:180,required:!0}),e.jsxs("div",{className:"flex gap-2 w-full",children:[e.jsx("button",{type:"button",className:"btn btn-secondary flex-1 rounded-full",onClick:()=>h("menu"),children:"Volver"}),e.jsx("button",{type:"submit",className:"btn btn-primary flex-1 rounded-full",disabled:N,children:N?"Publicando...":"Publicar"})]})]}),M==="photo"&&e.jsxs("form",{onSubmit:E,className:"flex flex-col items-center gap-4 w-full",children:[a&&e.jsxs("div",{className:"flex items-center gap-2 mb-2 w-full",children:[e.jsx("img",{src:a.avatar,alt:a.displayName,className:"w-10 h-10 rounded-full border-2 border-white shadow"}),e.jsx("span",{className:"font-semibold text-sm text-gray-800 dark:text-gray-100",children:(z=a.displayName)==null?void 0:z.split(" ")[0]})]}),e.jsxs("label",{className:"w-full flex flex-col items-center cursor-pointer",children:[e.jsx("span",{className:"mb-1 text-sm text-gray-600 dark:text-gray-300",children:"Selecciona una imagen"}),e.jsx("input",{type:"file",accept:"image/*",ref:T,onChange:t=>{var r;return L(((r=t.target.files)==null?void 0:r[0])||null)},className:"block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary-50 file:text-primary-700 hover:file:bg-primary-100",required:!0,style:{display:"none"}}),f&&e.jsx("img",{src:URL.createObjectURL(f),alt:"Vista previa",className:"w-full h-48 object-cover rounded-lg border"})]}),e.jsx("textarea",{className:"w-full rounded border p-2 text-sm focus:ring-2 focus:ring-primary-500",placeholder:"Texto opcional (máx. 180 caracteres)",value:v,onChange:t=>j(t.target.value),rows:2,maxLength:180}),e.jsxs("div",{className:"flex gap-2 w-full",children:[e.jsx("button",{type:"button",className:"btn btn-secondary flex-1 rounded-full",onClick:()=>h("menu"),children:"Volver"}),e.jsx("button",{type:"submit",className:"btn btn-accent flex-1 rounded-full",disabled:N,children:N?"Publicando...":"Publicar"})]})]}),e.jsx("p",{className:"text-xs text-gray-400 text-center mt-1",children:"Elige el tipo de historia que quieres crear."})]})}),e.jsx("div",{className:"pt-2 pb-2 rounded-xl shadow flex items-center mx-auto max-w-2xl border border-primary-100 dark:border-gray-800 bg-white dark:bg-gray-900",children:e.jsxs("div",{className:"flex overflow-x-auto space-x-4 px-4 py-2 hide-scrollbar w-full",children:[e.jsxs(k.div,{whileTap:{scale:.95},className:"flex flex-col items-center min-w-[80px] group cursor-pointer",onClick:()=>C(!0),children:[e.jsxs("div",{className:"w-16 h-16 rounded-full border-2 border-dashed border-primary-500 flex items-center justify-center bg-gradient-to-br from-primary-100 via-primary-50 to-white dark:from-primary-900/40 dark:via-primary-900/10 dark:to-gray-900 relative group transition-all duration-200 shadow-md hover:shadow-xl hover:scale-105 ring-2 ring-primary-200 dark:ring-primary-900/40",children:[a&&a.avatar?e.jsx("img",{src:a.avatar,alt:"Tu avatar",className:"w-14 h-14 rounded-full object-cover absolute top-1 left-1 z-10 border-2 border-white dark:border-gray-900 group-hover:ring-2 group-hover:ring-primary-400 shadow-lg"}):null,e.jsx(re,{className:"h-8 w-8 text-primary-500 z-20 group-hover:text-accent-500 transition-colors drop-shadow-lg"})]}),e.jsx("span",{className:"text-xs mt-1 text-gray-700 dark:text-gray-300 font-bold group-hover:text-primary-600 tracking-wide uppercase letter-spacing-wider transition-colors",children:"Crear"})]}),x.map((t,r)=>e.jsxs(k.div,{whileTap:{scale:.95},className:`flex flex-col items-center min-w-[80px] transition-all duration-200 group ${t.isViewed?"opacity-60":"opacity-100"}`,onClick:()=>B(t,r),style:{cursor:"pointer"},children:[e.jsx("div",{className:`w-16 h-16 rounded-full p-[2px] bg-gradient-to-br from-primary-500 to-accent-500 group-hover:scale-105 group-hover:shadow-lg transition-all duration-200 ${t.isViewed?"grayscale":""}`,children:e.jsx("img",{src:t.userAvatar,alt:t.userName,className:"w-full h-full rounded-full object-cover border-2 border-white dark:border-gray-900 group-hover:ring-2 group-hover:ring-accent-400"})}),e.jsx("span",{className:"text-xs mt-1 text-center truncate w-20 font-semibold group-hover:text-accent-600",children:t.userName.split(" ")[0]})]},t.id))]})}),e.jsx(K,{children:n&&e.jsxs(k.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.2},className:"fixed inset-0 z-50 bg-black flex items-center justify-center",onClick:q,children:[e.jsxs(k.div,{initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.9,opacity:0},transition:{duration:.2},className:"relative w-full h-full max-w-md mx-auto",onClick:t=>t.stopPropagation(),children:[e.jsx("div",{className:"absolute top-0 left-0 right-0 z-10 flex p-2 space-x-1",children:x.map((t,r)=>e.jsx("div",{className:`h-1 rounded-full flex-1 ${r<=u?"bg-white":"bg-white/30"}`},r))}),e.jsxs("div",{className:"h-full relative",children:[e.jsx("img",{src:n.imageUrl,alt:n.description,className:"w-full h-full object-cover"}),e.jsxs("div",{className:"absolute top-0 left-0 right-0 p-6 pt-8 flex items-center",children:[e.jsx("div",{className:"w-10 h-10 rounded-full overflow-hidden mr-3",children:e.jsx("img",{src:n.userAvatar,alt:n.userName,className:"w-full h-full object-cover"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-white font-medium",children:n.userName}),e.jsx("p",{className:"text-xs text-gray-300",children:new Date(n.createdAt).toLocaleString("es-ES",{hour:"2-digit",minute:"2-digit",hour12:!0})})]})]}),e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-black/80 via-black/50 to-transparent",children:[e.jsx("p",{className:"text-white mb-4",children:n.description}),e.jsxs("div",{className:"flex items-center space-x-5",children:[e.jsxs("button",{className:"text-white flex items-center",onClick:()=>W(n),disabled:H===n.id,children:[e.jsx(X,{className:"h-6 w-6 mr-1"}),e.jsx("span",{children:n.likes})]}),e.jsxs("form",{onSubmit:t=>{t.preventDefault(),F(n)},className:"flex items-center",children:[e.jsx("input",{type:"text",className:"rounded px-2 py-1 text-sm mr-2",placeholder:"Comentar...",value:U,onChange:t=>P(t.target.value)}),e.jsx("button",{type:"submit",className:"text-white",children:e.jsx(Y,{className:"h-6 w-6"})})]}),e.jsx("button",{className:"text-white",children:e.jsx(Z,{className:"h-6 w-6"})})]})]}),u>0&&e.jsx("button",{className:"absolute left-2 top-1/2 -translate-y-1/2 bg-black/30 p-1 rounded-full",onClick:Q,children:e.jsx(ee,{className:"h-8 w-8 text-white"})}),u<x.length-1&&e.jsx("button",{className:"absolute right-2 top-1/2 -translate-y-1/2 bg-black/30 p-1 rounded-full",onClick:O,children:e.jsx(te,{className:"h-8 w-8 text-white"})})]})]}),e.jsx("button",{className:"absolute top-4 right-4 text-white z-50",onClick:q,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-8 w-8",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})})]})};export{oe as default};
