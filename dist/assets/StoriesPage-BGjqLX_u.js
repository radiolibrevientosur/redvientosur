import{c as X,r as a,k as Y,j as e,l as W,n as Z,o as ee,p as te,q as re,b as ae,m as $,H as se,M as ie,s as _,a as S}from"./index-CSAYQrjP.js";import{S as oe}from"./share-2-tKKt0KTs.js";import{C as le,a as ne}from"./chevron-right-C8Nrkii7.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ce=X("PlusCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]);class de extends a.Component{getSnapshotBeforeUpdate(n){const s=this.props.childRef.current;if(s&&n.isPresent&&!this.props.isPresent){const o=this.props.sizeRef.current;o.height=s.offsetHeight||0,o.width=s.offsetWidth||0,o.top=s.offsetTop,o.left=s.offsetLeft}return null}componentDidUpdate(){}render(){return this.props.children}}function ue({children:r,isPresent:n}){const s=a.useId(),o=a.useRef(null),C=a.useRef({width:0,height:0,top:0,left:0}),{nonce:l}=a.useContext(Y);return a.useInsertionEffect(()=>{const{width:f,height:i,top:v,left:d}=C.current;if(n||!o.current||!f||!i)return;o.current.dataset.motionPopId=s;const u=document.createElement("style");return l&&(u.nonce=l),document.head.appendChild(u),u.sheet&&u.sheet.insertRule(`
          [data-motion-pop-id="${s}"] {
            position: absolute !important;
            width: ${f}px !important;
            height: ${i}px !important;
            top: ${v}px !important;
            left: ${d}px !important;
          }
        `),()=>{document.head.removeChild(u)}},[n]),e.jsx(de,{isPresent:n,childRef:o,sizeRef:C,children:a.cloneElement(r,{ref:o})})}const me=({children:r,initial:n,isPresent:s,onExitComplete:o,custom:C,presenceAffectsLayout:l,mode:f})=>{const i=W(pe),v=a.useId(),d=a.useCallback(h=>{i.set(h,!0);for(const j of i.values())if(!j)return;o&&o()},[i,o]),u=a.useMemo(()=>({id:v,initial:n,isPresent:s,custom:C,onExitComplete:d,register:h=>(i.set(h,!1),()=>i.delete(h))}),l?[Math.random(),d]:[s,d]);return a.useMemo(()=>{i.forEach((h,j)=>i.set(j,!1))},[s]),a.useEffect(()=>{!s&&!i.size&&o&&o()},[s]),f==="popLayout"&&(r=e.jsx(ue,{isPresent:s,children:r})),e.jsx(Z.Provider,{value:u,children:r})};function pe(){return new Map}const V=r=>r.key||"";function O(r){const n=[];return a.Children.forEach(r,s=>{a.isValidElement(s)&&n.push(s)}),n}const fe=({children:r,custom:n,initial:s=!0,onExitComplete:o,presenceAffectsLayout:C=!0,mode:l="sync",propagate:f=!1})=>{const[i,v]=ee(f),d=a.useMemo(()=>O(r),[r]),u=f&&!i?[]:d.map(V),h=a.useRef(!0),j=a.useRef(d),g=W(()=>new Map),[I,P]=a.useState(d),[N,A]=a.useState(d);te(()=>{h.current=!1,j.current=d;for(let b=0;b<N.length;b++){const c=V(N[b]);u.includes(c)?g.delete(c):g.get(c)!==!0&&g.set(c,!1)}},[N,u.length,u.join("-")]);const E=[];if(d!==I){let b=[...d];for(let c=0;c<N.length;c++){const w=N[c],R=V(w);u.includes(R)||(b.splice(c,0,w),E.push(w))}l==="wait"&&E.length&&(b=E),A(O(b)),P(d);return}const{forceRender:M}=a.useContext(re);return e.jsx(e.Fragment,{children:N.map(b=>{const c=V(b),w=f&&!i?!1:d===N||u.includes(c),R=()=>{if(g.has(c))g.set(c,!0);else return;let T=!0;g.forEach(U=>{U||(T=!1)}),T&&(M==null||M(),A(j.current),f&&(v==null||v()),o&&o())};return e.jsx(me,{isPresent:w,initial:!h.current||s?void 0:!1,custom:w?void 0:n,presenceAffectsLayout:C,mode:l,onExitComplete:w?void 0:R,children:b},c)})})},be=()=>{var H,B;const{user:r}=ae(),[n,s]=a.useState([]),[o,C]=a.useState(!0),[l,f]=a.useState(null),[i,v]=a.useState(0),[d,u]=a.useState(!1),[h,j]=a.useState(""),[g,I]=a.useState(null),[P,N]=a.useState(!1),[A,E]=a.useState(null),[M,b]=a.useState(""),[c,w]=a.useState("menu"),R=a.useRef(null);a.useEffect(()=>{(async()=>{C(!0);const{data:m,error:q}=await _.from("posts").select("id, autor_id, tipo, contenido, multimedia_url, creado_en, autor:usuarios(id, nombre_completo, avatar_url)").eq("tipo","story").order("creado_en",{ascending:!1});if(q){s([]),C(!1);return}const L=(m||[]).map(x=>{var y,p,k;return{id:x.id,userId:x.autor_id,userName:((y=x.autor)==null?void 0:y.nombre_completo)||"Usuario",userAvatar:((p=x.autor)==null?void 0:p.avatar_url)||"/default-avatar.png",imageUrl:((k=x.multimedia_url)==null?void 0:k[0])||"",description:x.contenido||"",createdAt:x.creado_en,likes:0,isViewed:!1}});s(L),C(!1)})()},[]);const T=(t,m)=>{f(t),v(m)},U=()=>{f(null)},F=t=>{t.stopPropagation(),i<n.length-1?(v(i+1),f(n[i+1])):U()},G=t=>{t.stopPropagation(),i>0&&(v(i-1),f(n[i-1]))},D=async t=>{if(t.preventDefault(),!r||!h&&!g){S.error("Agrega una imagen o texto");return}N(!0);let m="";if(g){const L=g.name.split(".").pop(),x=`stories/${r.id}_${Date.now()}.${L}`,{data:y,error:p}=await _.storage.from("event-images").upload(x,g);if(p){S.error("Error al subir la imagen"),N(!1);return}const{data:k}=_.storage.from("event-images").getPublicUrl(x);m=k.publicUrl}const{error:q}=await _.from("posts").insert({autor_id:r.id,tipo:"story",contenido:h,multimedia_url:m?[m]:[]});if(q)S.error("Error al crear story");else{S.success("¡Story publicada!"),u(!1),j(""),I(null);const{data:L,error:x}=await _.from("posts").select("id, autor_id, tipo, contenido, multimedia_url, creado_en, autor:usuarios(id, nombre_completo, avatar_url)").eq("tipo","story").order("creado_en",{ascending:!1});if(!x){const y=(L||[]).map(p=>{var k,z,K;return{id:p.id,userId:p.autor_id,userName:((k=p.autor)==null?void 0:k.nombre_completo)||"Usuario",userAvatar:((z=p.autor)==null?void 0:z.avatar_url)||"/default-avatar.png",imageUrl:((K=p.multimedia_url)==null?void 0:K[0])||"",description:p.contenido||"",createdAt:p.creado_en,likes:0,isViewed:!1}});s(y)}}N(!1)},Q=async t=>{if(!r)return S.error("Inicia sesión para dar like");E(t.id);const{data:m}=await _.from("reacciones_post").select("*").eq("post_id",t.id).eq("usuario_id",r.id).single();m?(await _.from("reacciones_post").delete().eq("post_id",t.id).eq("usuario_id",r.id),S("Like eliminado")):(await _.from("reacciones_post").insert({post_id:t.id,usuario_id:r.id,tipo:"like"}),S("¡Te gustó la story!")),E(null);const{data:q,error:L}=await _.from("posts").select("id, autor_id, tipo, contenido, multimedia_url, creado_en, autor:usuarios(id, nombre_completo, avatar_url)").eq("tipo","story").order("creado_en",{ascending:!1});if(!L){const x=(q||[]).map(y=>{var p,k,z;return{id:y.id,userId:y.autor_id,userName:((p=y.autor)==null?void 0:p.nombre_completo)||"Usuario",userAvatar:((k=y.autor)==null?void 0:k.avatar_url)||"/default-avatar.png",imageUrl:((z=y.multimedia_url)==null?void 0:z[0])||"",description:y.contenido||"",createdAt:y.creado_en,likes:0,isViewed:!1}});s(x)}},J=async t=>{!r||!M.trim()||(await _.from("comentarios_post").insert({post_id:t.id,autor_id:r.id,contenido:M.trim()}),S.success("Comentario enviado"),b(""))};return o?null:e.jsxs("div",{className:"space-y-6",children:[d&&e.jsx("div",{className:"fixed inset-0 z-50 bg-black/70 flex items-center justify-center",children:e.jsxs("div",{className:"relative bg-white dark:bg-gray-900 rounded-2xl shadow-2xl w-full max-w-xs sm:max-w-md flex flex-col items-center gap-4 p-6",children:[e.jsx("button",{type:"button",className:"absolute top-3 right-3 text-gray-400 hover:text-gray-700 text-2xl z-20",onClick:()=>{u(!1),w("menu"),j(""),I(null)},"aria-label":"Cerrar",children:"×"}),e.jsx("h3",{className:"text-lg font-bold mb-2 text-center w-full",children:"Crear historia"}),c==="menu"&&e.jsxs("div",{className:"flex flex-col gap-4 w-full",children:[e.jsx("button",{type:"button",className:"btn btn-primary w-full rounded-full py-2 text-base font-semibold",onClick:()=>w("text"),children:"Historia de texto"}),e.jsx("button",{type:"button",className:"btn btn-accent w-full rounded-full py-2 text-base font-semibold",onClick:()=>{w("photo"),setTimeout(()=>{var t;return(t=R.current)==null?void 0:t.click()},100)},children:"Historia de foto"})]}),c==="text"&&e.jsxs("form",{onSubmit:D,className:"flex flex-col items-center gap-4 w-full",children:[r&&e.jsxs("div",{className:"flex items-center gap-2 mb-2 w-full",children:[e.jsx("img",{src:r.avatar,alt:r.displayName,className:"w-10 h-10 rounded-full border-2 border-white shadow"}),e.jsx("span",{className:"font-semibold text-sm text-gray-800 dark:text-gray-100",children:(H=r.displayName)==null?void 0:H.split(" ")[0]})]}),e.jsx("textarea",{className:"w-full rounded border p-2 text-sm focus:ring-2 focus:ring-primary-500",placeholder:"¿Qué quieres compartir? (máx. 180 caracteres)",value:h,onChange:t=>j(t.target.value),rows:4,maxLength:180,required:!0}),e.jsxs("div",{className:"flex gap-2 w-full",children:[e.jsx("button",{type:"button",className:"btn btn-secondary flex-1 rounded-full",onClick:()=>w("menu"),children:"Volver"}),e.jsx("button",{type:"submit",className:"btn btn-primary flex-1 rounded-full",disabled:P,children:P?"Publicando...":"Publicar"})]})]}),c==="photo"&&e.jsxs("form",{onSubmit:D,className:"flex flex-col items-center gap-4 w-full",children:[r&&e.jsxs("div",{className:"flex items-center gap-2 mb-2 w-full",children:[e.jsx("img",{src:r.avatar,alt:r.displayName,className:"w-10 h-10 rounded-full border-2 border-white shadow"}),e.jsx("span",{className:"font-semibold text-sm text-gray-800 dark:text-gray-100",children:(B=r.displayName)==null?void 0:B.split(" ")[0]})]}),e.jsxs("label",{className:"w-full flex flex-col items-center cursor-pointer",children:[e.jsx("span",{className:"mb-1 text-sm text-gray-600 dark:text-gray-300",children:"Selecciona una imagen"}),e.jsx("input",{type:"file",accept:"image/*",ref:R,onChange:t=>{var m;return I(((m=t.target.files)==null?void 0:m[0])||null)},className:"block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary-50 file:text-primary-700 hover:file:bg-primary-100",required:!0,style:{display:"none"}}),g&&e.jsx("img",{src:URL.createObjectURL(g),alt:"Vista previa",className:"w-full h-48 object-cover rounded-lg border"})]}),e.jsx("textarea",{className:"w-full rounded border p-2 text-sm focus:ring-2 focus:ring-primary-500",placeholder:"Texto opcional (máx. 180 caracteres)",value:h,onChange:t=>j(t.target.value),rows:2,maxLength:180}),e.jsxs("div",{className:"flex gap-2 w-full",children:[e.jsx("button",{type:"button",className:"btn btn-secondary flex-1 rounded-full",onClick:()=>w("menu"),children:"Volver"}),e.jsx("button",{type:"submit",className:"btn btn-accent flex-1 rounded-full",disabled:P,children:P?"Publicando...":"Publicar"})]})]}),e.jsx("p",{className:"text-xs text-gray-400 text-center mt-1",children:"Elige el tipo de historia que quieres crear."})]})}),e.jsx("div",{className:"pt-2 pb-2 rounded-xl shadow flex items-center mx-auto max-w-2xl border border-primary-100 dark:border-gray-800 bg-white dark:bg-gray-900",children:e.jsxs("div",{className:"flex overflow-x-auto space-x-4 px-4 py-2 hide-scrollbar w-full",children:[e.jsxs($.div,{whileTap:{scale:.95},className:"flex flex-col items-center min-w-[80px] group cursor-pointer",onClick:()=>u(!0),children:[e.jsxs("div",{className:"w-16 h-16 rounded-full border-2 border-dashed border-primary-500 flex items-center justify-center bg-gradient-to-br from-primary-100 via-primary-50 to-white dark:from-primary-900/40 dark:via-primary-900/10 dark:to-gray-900 relative group transition-all duration-200 shadow-md hover:shadow-xl hover:scale-105 ring-2 ring-primary-200 dark:ring-primary-900/40",children:[r&&r.avatar?e.jsx("img",{src:r.avatar,alt:"Tu avatar",className:"w-14 h-14 rounded-full object-cover absolute top-1 left-1 z-10 border-2 border-white dark:border-gray-900 group-hover:ring-2 group-hover:ring-primary-400 shadow-lg"}):null,e.jsx(ce,{className:"h-8 w-8 text-primary-500 z-20 group-hover:text-accent-500 transition-colors drop-shadow-lg"})]}),e.jsx("span",{className:"text-xs mt-1 text-gray-700 dark:text-gray-300 font-bold group-hover:text-primary-600 tracking-wide uppercase letter-spacing-wider transition-colors",children:"Crear"})]}),n.map((t,m)=>e.jsxs($.div,{whileTap:{scale:.95},className:`flex flex-col items-center min-w-[80px] transition-all duration-200 group ${t.isViewed?"opacity-60":"opacity-100"}`,onClick:()=>T(t,m),style:{cursor:"pointer"},children:[e.jsx("div",{className:`w-16 h-16 rounded-full p-[2px] bg-gradient-to-br from-primary-500 to-accent-500 group-hover:scale-105 group-hover:shadow-lg transition-all duration-200 ${t.isViewed?"grayscale":""}`,children:e.jsx("img",{src:t.userAvatar,alt:t.userName,className:"w-full h-full rounded-full object-cover border-2 border-white dark:border-gray-900 group-hover:ring-2 group-hover:ring-accent-400"})}),e.jsx("span",{className:"text-xs mt-1 text-center truncate w-20 font-semibold group-hover:text-accent-600",children:t.userName.split(" ")[0]})]},t.id))]})}),e.jsx(fe,{children:l&&e.jsxs($.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.2},className:"fixed inset-0 z-50 bg-black flex items-center justify-center",onClick:U,children:[e.jsxs($.div,{initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.9,opacity:0},transition:{duration:.2},className:"relative w-full h-full max-w-md mx-auto",onClick:t=>t.stopPropagation(),children:[e.jsx("div",{className:"absolute top-0 left-0 right-0 z-10 flex p-2 space-x-1",children:n.map((t,m)=>e.jsx("div",{className:`h-1 rounded-full flex-1 ${m<=i?"bg-white":"bg-white/30"}`},m))}),e.jsxs("div",{className:"h-full relative",children:[e.jsx("img",{src:l.imageUrl,alt:l.description,className:"w-full h-full object-cover"}),e.jsxs("div",{className:"absolute top-0 left-0 right-0 p-6 pt-8 flex items-center",children:[e.jsx("div",{className:"w-10 h-10 rounded-full overflow-hidden mr-3",children:e.jsx("img",{src:l.userAvatar,alt:l.userName,className:"w-full h-full object-cover"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-white font-medium",children:l.userName}),e.jsx("p",{className:"text-xs text-gray-300",children:new Date(l.createdAt).toLocaleString("es-ES",{hour:"2-digit",minute:"2-digit",hour12:!0})})]})]}),e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-black/80 via-black/50 to-transparent",children:[e.jsx("p",{className:"text-white mb-4",children:l.description}),e.jsxs("div",{className:"flex items-center space-x-5",children:[e.jsxs("button",{className:"text-white flex items-center",onClick:()=>Q(l),disabled:A===l.id,children:[e.jsx(se,{className:"h-6 w-6 mr-1"}),e.jsx("span",{children:l.likes})]}),e.jsxs("form",{onSubmit:t=>{t.preventDefault(),J(l)},className:"flex items-center",children:[e.jsx("input",{type:"text",className:"rounded px-2 py-1 text-sm mr-2",placeholder:"Comentar...",value:M,onChange:t=>b(t.target.value)}),e.jsx("button",{type:"submit",className:"text-white",children:e.jsx(ie,{className:"h-6 w-6"})})]}),e.jsx("button",{className:"text-white",children:e.jsx(oe,{className:"h-6 w-6"})})]})]}),i>0&&e.jsx("button",{className:"absolute left-2 top-1/2 -translate-y-1/2 bg-black/30 p-1 rounded-full",onClick:G,children:e.jsx(le,{className:"h-8 w-8 text-white"})}),i<n.length-1&&e.jsx("button",{className:"absolute right-2 top-1/2 -translate-y-1/2 bg-black/30 p-1 rounded-full",onClick:F,children:e.jsx(ne,{className:"h-8 w-8 text-white"})})]})]}),e.jsx("button",{className:"absolute top-4 right-4 text-white z-50",onClick:U,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-8 w-8",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})})]})};export{be as default};
