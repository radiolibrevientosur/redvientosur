import{t as l,D as w,i as L,F as O,G as S,J as y,K as F,s as m,d as g}from"./index-CkCNI7dU.js";import{e as U,c as x}from"./endOfMonth-CxbF7xh5.js";function D(n,o){const e=l(n),i=l(o),t=e.getTime()-i.getTime();return t<0?-1:t>0?1:t}function A(n,o){const e=l(n),i=l(o),t=e.getFullYear()-i.getFullYear(),a=e.getMonth()-i.getMonth();return t*12+a}function X(n){return o=>{const i=(n?Math[n]:Math.trunc)(o);return i===0?0:i}}function p(n,o){return+l(n)-+l(o)}function N(n){const o=l(n);return o.setHours(23,59,59,999),o}function T(n){const o=l(n);return+N(o)==+U(o)}function b(n,o){const e=l(n),i=l(o),t=D(e,i),a=Math.abs(A(e,i));let r;if(a<1)r=0;else{e.getMonth()===1&&e.getDate()>27&&e.setDate(30),e.setMonth(e.getMonth()-t*a);let s=D(e,i)===-t;T(l(n))&&a===1&&D(n,i)===1&&(s=!1),r=t*(a-Number(s))}return r===0?0:r}function k(n,o,e){const i=p(n,o)/1e3;return X(e==null?void 0:e.roundingMethod)(i)}function E(n,o,e){const i=L(),t=(e==null?void 0:e.locale)??i.locale??O,a=2520,r=D(n,o);if(isNaN(r))throw new RangeError("Invalid time value");const s=Object.assign({},e,{addSuffix:e==null?void 0:e.addSuffix,comparison:r});let u,c;r>0?(u=l(o),c=l(n)):(u=l(n),c=l(o));const f=k(c,u),v=(w(c)-w(u))/1e3,d=Math.round((f-v)/60);let h;if(d<2)return e!=null&&e.includeSeconds?f<5?t.formatDistance("lessThanXSeconds",5,s):f<10?t.formatDistance("lessThanXSeconds",10,s):f<20?t.formatDistance("lessThanXSeconds",20,s):f<40?t.formatDistance("halfAMinute",0,s):f<60?t.formatDistance("lessThanXMinutes",1,s):t.formatDistance("xMinutes",1,s):d===0?t.formatDistance("lessThanXMinutes",1,s):t.formatDistance("xMinutes",d,s);if(d<45)return t.formatDistance("xMinutes",d,s);if(d<90)return t.formatDistance("aboutXHours",1,s);if(d<S){const _=Math.round(d/60);return t.formatDistance("aboutXHours",_,s)}else{if(d<a)return t.formatDistance("xDays",1,s);if(d<y){const _=Math.round(d/S);return t.formatDistance("xDays",_,s)}else if(d<y*2)return h=Math.round(d/y),t.formatDistance("aboutXMonths",h,s)}if(h=b(c,u),h<12){const _=Math.round(d/y);return t.formatDistance("xMonths",_,s)}else{const _=h%12,M=Math.trunc(h/12);return _<3?t.formatDistance("aboutXYears",M,s):_<9?t.formatDistance("overXYears",M,s):t.formatDistance("almostXYears",M+1,s)}}function P(n,o){return E(n,x(n),o)}const R=F((n,o)=>({posts:[],isLoading:!1,error:null,fetchPosts:async()=>{n({isLoading:!0,error:null});try{const{data:e,error:i}=await m.from("posts").select(`
          *,
          autor:usuarios(*),
          comentarios:comentarios_post(*),
          reacciones:reacciones_post(*)
        `).order("creado_en",{ascending:!1});if(i)throw i;const t=await Promise.all(e.map(async a=>{var u;const{data:r}=await m.from("favoritos_post").select("*").eq("post_id",a.id).single();let s=[];if(a.media_urls)try{s=typeof a.media_urls=="string"?JSON.parse(a.media_urls):a.media_urls}catch{s=[]}else a.multimedia_url&&Array.isArray(a.multimedia_url)&&(s=a.multimedia_url.map(c=>({url:c,type:"image",name:""})));return{id:a.id,userId:a.autor_id,type:a.tipo,content:a.contenido,mediaUrl:(u=a.multimedia_url)==null?void 0:u[0],mediaUrls:s,createdAt:a.creado_en,likes:a.reacciones.map(c=>c.usuario_id),comments:a.comentarios.map(c=>({id:c.id,userId:c.autor_id,content:c.contenido,createdAt:c.creado_en})),isFavorite:!!r}}));n({posts:t,isLoading:!1})}catch(e){n({error:e instanceof Error?e.message:"Error al cargar posts",isLoading:!1})}},addPost:async e=>{var i;n({isLoading:!0,error:null});try{const t=new Date().toISOString(),a={autor_id:e.userId,tipo:e.type,contenido:e.content,multimedia_url:e.mediaUrls?e.mediaUrls.map(f=>f.url):e.mediaUrl?[e.mediaUrl]:[],media_urls:e.mediaUrls?JSON.stringify(e.mediaUrls):null,creado_en:t,actualizado_en:t},{data:r,error:s}=await m.from("posts").insert(a).select().single();if(s)throw s;let u=[];if(r.media_urls)try{u=typeof r.media_urls=="string"?JSON.parse(r.media_urls):r.media_urls}catch{u=[]}else r.multimedia_url&&Array.isArray(r.multimedia_url)&&(u=r.multimedia_url.map(f=>({url:f,type:"image",name:""})));const c={id:r.id,userId:r.autor_id,type:r.tipo,content:r.contenido,mediaUrl:(i=r.multimedia_url)==null?void 0:i[0],mediaUrls:u,createdAt:r.creado_en,likes:[],comments:[],isFavorite:!1};n(f=>({posts:[c,...f.posts],isLoading:!1})),g.success("¡Publicación creada exitosamente!")}catch(t){n({error:t instanceof Error?t.message:"Error al crear post",isLoading:!1}),g.error("Error al crear post")}},toggleLike:async(e,i)=>{try{const t=o().posts.find(r=>r.id===e);if(!t)return;const a=t.likes.includes(i);if(a){const{error:r}=await m.from("reacciones_post").delete().eq("post_id",e).eq("usuario_id",i);if(r)throw r}else{const{error:r}=await m.from("reacciones_post").insert({post_id:e,usuario_id:i,tipo:"like"});if(r)throw r}n(r=>({posts:r.posts.map(s=>s.id===e?{...s,likes:a?s.likes.filter(u=>u!==i):[...s.likes,i]}:s)}))}catch{g.error("Error al actualizar reacción")}},addComment:async(e,i,t)=>{try{const{data:a,error:r}=await m.from("comentarios_post").insert({post_id:e,autor_id:i,contenido:t}).select().single();if(r)throw r;const s={id:a.id,userId:a.autor_id,content:a.contenido,createdAt:a.creado_en};n(u=>({posts:u.posts.map(c=>c.id===e?{...c,comments:[...c.comments,s]}:c)})),g.success("Comentario agregado")}catch{g.error("Error al agregar comentario")}},toggleFavorite:async e=>{var i;try{const t=o().posts.find(r=>r.id===e);if(!t)return;const{data:a}=await m.auth.getSession();if(!((i=a==null?void 0:a.session)!=null&&i.user))return;if(t.isFavorite){const{error:r}=await m.from("favoritos_post").delete().eq("post_id",e).eq("usuario_id",a.session.user.id);if(r)throw r}else{const{error:r}=await m.from("favoritos_post").insert({post_id:e,usuario_id:a.session.user.id});if(r)throw r}n(r=>({posts:r.posts.map(s=>s.id===e?{...s,isFavorite:!s.isFavorite}:s)}))}catch{g.error("Error al actualizar favoritos")}},getFavoritePosts:()=>o().posts.filter(e=>e.isFavorite)})),Y=async n=>{const{data:o,error:e}=await m.from("usuarios").select("*").eq("id",n).single();return e?null:{id:o.id,username:o.nombre_usuario,displayName:o.nombre_completo,avatar:o.avatar_url}},z=n=>P(new Date(n),{addSuffix:!0});export{z as f,Y as g,R as u};
